<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Arena: Factions v1.5</title>
    <style>
        :root {
            --board-size: 720px; --tile-size: calc(var(--board-size) / 8); --p1-color: #4a90e2; --p2-color: #e24a4a; --gold-color: #f5a623;
            --highlight-move: rgba(74, 144, 226, 0.4); --highlight-attack: rgba(226, 74, 74, 0.5);
        }
        body { font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #2c2f33; color: white; margin: 0; overflow: hidden; }
        #game-container { display: flex; gap: 20px; align-items: flex-start; position: relative; margin-left: 260px; }
        #game-board { width: var(--board-size); height: var(--board-size); display: grid; grid-template-columns: repeat(8, 1fr); border: 5px solid #1a1a1a; position: relative; }
        .tile { width: var(--tile-size); height: var(--tile-size); display: flex; justify-content: center; align-items: center; position: relative; }
        .tile.light { background-color: #f0d9b5; } .tile.dark { background-color: #b58863; }
        .tile.selected { box-shadow: inset 0 0 0 3px var(--gold-color); }
        .tile.valid-move { background-color: var(--highlight-move) !important; }
        .tile.valid-attack { background-color: var(--highlight-attack) !important; }
        .tile.spawn { background-color: rgba(74, 226, 74, 0.4) !important; }
        .tile.forest::before, .tile.bush::before { position: absolute; font-size: calc(var(--tile-size) * 0.8); opacity: 0.4; z-index: 0; }
        .tile.forest::before { content: 'üå≥'; }
        .tile.bush::before { content: 'üåø'; opacity: 0.6; }
        .tile .item-gold { position: absolute; font-size: calc(var(--tile-size) * 0.5); z-index: 2; animation: bounce-item 1.5s infinite ease-in-out; }
        @keyframes bounce-item { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .unit-wrapper { position: absolute; width: var(--tile-size); height: var(--tile-size); display: flex; justify-content: center; align-items: center; z-index: 3; transition: transform 0.4s ease-in-out, opacity 0.3s ease; pointer-events: none; }
        .unit-wrapper.hidden { opacity: 0.5; filter: grayscale(50%); }
        .unit { font-size: calc(var(--tile-size) * 0.5); line-height: 1; user-select: none; position: relative; }
        .unit.player1::after, .unit.cpu::after { content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 40px; height: 3px; border-radius: 2px; }
        .unit.player1::after { background: var(--p1-color); box-shadow: 0 0 4px var(--p1-color); }
        .unit.cpu::after { background: var(--p2-color); box-shadow: 0 0 4px var(--p2-color); }
        .unit-hp-bar { position: absolute; bottom: 5px; width: 70%; height: 8px; background-color: #555; border-radius: 4px; border: 1px solid #000; overflow: hidden; }
        .unit-hp-bar-inner { height: 100%; background-color: #4caf50; transition: width 0.3s ease; }
        .base-health { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; font-weight: bold; z-index: 4; text-align: center; }
        .base-health.player1 { border: 1px solid var(--p1-color); } .base-health.cpu { border: 1px solid var(--p2-color); }
        .unit-wrapper.attacking { animation: unit-attack 0.6s ease-in-out; z-index: 6; }
        @keyframes unit-attack { 0%, 100% { transform: translate(var(--start-x), var(--start-y)) scale(1); } 50% { transform: translate(var(--attack-x), var(--attack-y)) scale(1.2); } }
        .unit-wrapper.dying { animation: unit-death 0.8s ease-out forwards; }
        @keyframes unit-death { 0% { transform: translate(var(--start-x), var(--start-y)) scale(1); opacity: 1; } 100% { transform: translate(var(--start-x), var(--start-y)) scale(0); opacity: 0; } }
        .unit-wrapper.summoning { animation: unit-summon 0.4s ease-out; }
        @keyframes unit-summon { 0% { transform: translate(var(--start-x), var(--start-y)) scale(0); opacity: 0; } 80% { transform: translate(var(--start-x), var(--start-y)) scale(1.2); } 100% { transform: translate(var(--start-x), var(--start-y)) scale(1); } }
        .damage-popup { position: absolute; font-size: 1.5em; font-weight: bold; color: red; text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff; z-index: 10; pointer-events: none; animation: float-up 1s ease-out forwards; }
        @keyframes float-up { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }
        #ui-panel { width: 280px; padding: 20px; background: #23272a; border-radius: 10px; display: flex; flex-direction: column; gap: 15px; max-height: 90vh; overflow-y: auto; }
        .player-info { padding: 10px; border-radius: 8px; } .player-info.player1 { background: var(--p1-color); } .player-info.cpu { background: var(--p2-color); }
        .player-info h3, .player-info p { margin: 0; }
        #turn-info { text-align: center; font-size: 1.2em; font-weight: bold; }
		#difficulty-info { text-align: center; font-size: 0.9em; color: #aaa; margin-top: -10px; }
        .shop-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #3a3f44; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        .shop-item:hover { background: #4a4f54; } .shop-item .unit-icon { font-size: 32px; line-height: 1; }
        #unit-tooltip { position: fixed; width: 200px; background: rgba(0,0,0,0.95); border: 2px solid var(--gold-color); border-radius: 8px; padding: 15px; z-index: 10000; display: none; pointer-events: none; }
        #unit-tooltip h4 { margin: 0 0 10px 0; color: var(--gold-color); } .unit-tooltip .stat-row { display: flex; justify-content: space-between; margin: 4px 0; font-size: 0.9em; }
        #end-turn-btn { width: 100%; padding: 15px; font-size: 1.1em; font-weight: bold; cursor: pointer; border: none; border-radius: 5px; background-color: #7289da; color: white; }
        #game-log { position: fixed; left: 20px; top: 50%; transform: translateY(-50%); width: 220px; height: 500px; background: rgba(0,0,0,0.9); border-radius: 10px; padding: 15px; color: white; overflow-y: auto; font-size: 0.85em; border: 2px solid #444; z-index: 100; }
        #game-log h3 { margin: 0 0 10px 0; padding-bottom: 10px; border-bottom: 1px solid #666; color: #f39c12; }
        #game-log-content { flex: 1; overflow-y: auto; }
        .log-entry { margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 3px; animation: slideIn 0.3s ease; font-size: 0.8em; }
        .log-entry.player1 { border-left: 3px solid #7289da; } .log-entry.cpu { border-left: 3px solid #e74c3c; } .log-entry.system { border-left: 3px solid #f39c12; font-weight: bold; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: #2c2f33; padding: 30px; border-radius: 10px; text-align: center; border: 2px solid #7289da; }
        .modal-content button { padding: 10px 20px; font-size: 1em; margin: 5px; cursor: pointer; border-radius: 5px; border: none; background-color: #4a4f54; color: white; }
        .faction-btn { display: flex; flex-direction: column; align-items: center; padding: 15px; border: 2px solid transparent; cursor: pointer; border-radius: 8px; width: 150px; text-align: center; background: rgba(255,255,255,0.05); }
        .faction-btn.selected { border-color: var(--gold-color); } .faction-icon { font-size: 40px; margin-bottom: 8px; }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="game-log"><h3 data-lang-key="log"></h3><div id="game-log-content"></div></div>
        <div id="game-board"></div>
        <div id="ui-panel">
            <div id="turn-info"></div><div id="difficulty-info"></div>
            <div class="player-info player1"><h3 data-lang-key="player1"></h3><p><span data-lang-key="gold"></span>: <span id="p1-gold"></span></p></div>
            <div class="player-info cpu"><h3 data-lang-key="cpu"></h3><p><span data-lang-key="gold"></span>: <span id="cpu-gold"></span></p></div>
            <div id="shop" style="position: relative;">
                <h4 class="ui-title" data-lang-key="shop"></h4>
                <div class="shop-item" data-unit="Pawn"><span></span><span class="unit-icon">‚ôü</span></div>
                <div class="shop-item" data-unit="Rook"><span></span><span class="unit-icon">‚ôú</span></div>
                <div class="shop-item" data-unit="Knight"><span></span><span class="unit-icon">‚ôû</span></div>
                <div class="shop-item" data-unit="Bishop"><span></span><span class="unit-icon">‚ôù</span></div>
                <div class="shop-item" data-unit="Queen"><span></span><span class="unit-icon">‚ôõ</span></div>
                <div id="unit-tooltip"></div>
            </div>
            <button id="end-turn-btn" data-lang-key="endTurn"></button>
        </div>
    </div>
    <div class="modal-overlay" id="lang-modal"><div class="modal-content"><h2 data-lang-key="langSelectTitle"></h2><button data-lang="en">English</button><button data-lang="ko">ÌïúÍµ≠Ïñ¥</button></div></div>
    <div class="modal-overlay" id="tutorial-modal"><div class="modal-content"><h2 data-lang-key="welcome"></h2><p data-lang-key="tutorialPrompt"></p><button id="start-tutorial-btn" data-lang-key="yesTutorial"></button><button id="skip-tutorial-btn" data-lang-key="noTutorial"></button></div></div>
    <div class="modal-overlay" id="faction-modal"><div class="modal-content"><h2 data-lang-key="factionSelect"></h2><p data-lang-key="factionDesc"></p><div class="faction-selection"><button class="faction-btn selected" data-faction="human"><div class="faction-icon">üë•</div><span data-lang-key="human"></span></button><button class="faction-btn" data-faction="undead"><div class="faction-icon">üíÄ</div><span data-lang-key="undead"></span></button><button class="faction-btn" data-faction="elf"><div class="faction-icon">üßù</div><span data-lang-key="elf"></span></button></div><button id="confirm-faction-btn" style="margin-top:20px;" data-lang-key="confirmFaction"></button></div></div>
    <div class="modal-overlay" id="difficulty-modal"><div class="modal-content"><h2 data-lang-key="difficultySelect"></h2><p data-lang-key="difficultyDesc"></p><button class="difficulty-btn" data-difficulty="easy" data-lang-key="easy"></button><button class="difficulty-btn" data-difficulty="medium" data-lang-key="medium"></button><button class="difficulty-btn" data-difficulty="hard" data-lang-key="hard"></button></div></div>
    <div class="modal-overlay" id="game-over-modal"><div class="modal-content"><h2 id="game-over-title"></h2><p id="game-over-message"></p><button id="restart-btn" data-lang-key="restart"></button></div></div>

    <script>
    let currentLang = 'ko';
    let LANG_STRINGS = {};
    document.addEventListener('DOMContentLoaded', () => {
        LANG_STRINGS = {
            en: { langSelectTitle: "Language", welcome: "Welcome!", tutorialPrompt: "Play the tutorial?", yesTutorial: "Yes", noTutorial: "No", factionSelect: "Select Faction", factionDesc: "Each faction has a perk.", human: "Human", undead: "Undead", elf: "Elf", confirmFaction: "Confirm", difficultySelect: "Difficulty", difficultyDesc: "Choose CPU difficulty.", easy: "Easy", medium: "Medium", hard: "Hard", restart: "Restart", gold: "Gold", shop: "Shop", log: "Game Log", endTurn: "End Turn", turnInfo: "Turn {turn} - {player}", difficultyLabel: "Difficulty", pawn: "Pawn", rook: "Rook", knight: "Knight", bishop: "Bishop", queen: "Queen", player1: "Player 1", cpu: "CPU", msgGold: "Not enough gold.", msgSpawn: "Place near your base.", wins: "{winner} Wins!", log_buy: "{player} bought {unit}", log_move: "{player}'s {unit} to ({x},{y})", log_gold_item: "{player} got +{gold} Gold!", log_attack: "{attackerUnit} hits {targetUnit} for {damage} dmg", log_destroy: "{unit} destroyed", log_item_spawn: "A gold pouch appeared!", log_turn_start: "--- {player}'s turn ---", log_defense: "üö® Emergency Defense! Base is under attack!", t_buy: "This is the shop. Click a Pawn to buy it.", t_place: "Now click a highlighted tile to place your Pawn.", t_select: "Click your Pawn to see its actions.", t_move: "Click the blue tile to move. Moving ends the unit's turn.", t_attack: "Click the red tile to attack. Attacking also ends the turn.", t_end: "Tutorial complete! Destroy the enemy base to win." },
            ko: { langSelectTitle: "Ïñ∏Ïñ¥ ÏÑ†ÌÉù", welcome: "ÌôòÏòÅÌï©ÎãàÎã§!", tutorialPrompt: "ÌäúÌÜ†Î¶¨ÏñºÏùÑ ÏßÑÌñâÌï†ÍπåÏöî?", yesTutorial: "Ïòà", noTutorial: "ÏïÑÎãàÏò§", factionSelect: "Ï¢ÖÏ°± ÏÑ†ÌÉù", factionDesc: "Í∞Å Ï¢ÖÏ°±ÏùÄ Í≥†Ïú† ÌäπÏÑ±Ïù¥ ÏûàÏäµÎãàÎã§.", human: "Ìú¥Î®º", undead: "Ïñ∏Îç∞Îìú", elf: "ÏóòÌîÑ", confirmFaction: "Í≤∞Ï†ï", difficultySelect: "ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù", difficultyDesc: "CPU ÎÇúÏù¥ÎèÑÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.", easy: "Ïâ¨ÏõÄ", medium: "Î≥¥ÌÜµ", hard: "Ïñ¥Î†§ÏõÄ", restart: "Îã§Ïãú ÏãúÏûë", gold: "Í≥®Îìú", shop: "ÏÉÅÏ†ê", log: "Í≤åÏûÑ Î°úÍ∑∏", endTurn: "ÌÑ¥ Ï¢ÖÎ£å", turnInfo: "{turn}ÌÑ¥ - {player}", difficultyLabel: "ÎÇúÏù¥ÎèÑ", pawn: "Î≥¥Î≥ë", rook: "ÌÉÄÏõå", knight: "Í∏∞ÏÇ¨", bishop: "ÎßàÎ≤ïÏÇ¨", queen: "Ïó¨Ïôï", player1: "ÌîåÎ†àÏù¥Ïñ¥ 1", cpu: "CPU", msgGold: "Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§.", msgSpawn: "Í∏∞ÏßÄ Í∑ºÏ≤òÏóê Î∞∞ÏπòÌïòÏÑ∏Ïöî.", wins: "{winner} ÏäπÎ¶¨!", log_buy: "{player}Í∞Ä {unit} Íµ¨Îß§", log_move: "{player}Ïùò {unit}Ïù¥ ({x},{y})(Ïúº)Î°ú Ïù¥Îèô", log_gold_item: "{player}Í∞Ä +{gold} Í≥®Îìú ÌöçÎìù!", log_attack: "{attackerUnit}Ïù¥ {targetUnit}ÏóêÍ≤å {damage} ÌîºÌï¥", log_destroy: "{unit} ÌååÍ¥¥Îê®", log_item_spawn: "Í≥®Îìú Ï£ºÎ®∏ÎãàÍ∞Ä ÎÇòÌÉÄÎÇ¨ÏäµÎãàÎã§!", log_turn_start: "--- {player} ÌÑ¥ ÏãúÏûë ---", log_defense: "üö® Í∏¥Í∏â Î∞©Ïñ¥! Í∏∞ÏßÄÎ•º ÏúÑÌòëÌïòÎäî Ï†Å Î∞úÍ≤¨!", t_buy: "Ïú†Îãõ ÏÉÅÏ†êÏûÖÎãàÎã§. Î≥¥Î≥ëÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Íµ¨Îß§ÌïòÏÑ∏Ïöî.", t_place: "Ïù¥Ï†ú ÎÖπÏÉâÏúºÎ°ú ÌëúÏãúÎêú ÌÉÄÏùºÏóê Î≥¥Î≥ëÏùÑ Î∞∞ÏπòÌïòÏÑ∏Ïöî.", t_select: "ÏûêÏã†Ïùò Î≥¥Î≥ëÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÌñâÎèôÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.", t_move: "ÌååÎûÄÏÉâ ÌÉÄÏùºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Ïù¥ÎèôÌïòÏÑ∏Ïöî. Ïù¥ÎèôÌïòÎ©¥ ÌÑ¥Ïù¥ ÏÜåÎ™®Îê©ÎãàÎã§.", t_attack: "Î∂âÏùÄÏÉâ ÌÉÄÏùºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Í≥µÍ≤©ÌïòÏÑ∏Ïöî. Í≥µÍ≤©ÎèÑ ÌÑ¥ÏùÑ ÏÜåÎ™®Ìï©ÎãàÎã§.", t_end: "ÌäúÌÜ†Î¶¨Ïñº ÏôÑÎ£å! Ïù¥Ï†ú Ï†ÅÏùò Í∏∞ÏßÄÎ•º ÌååÍ¥¥ÌïòÏÑ∏Ïöî." },
        };
        const t = (key, params = {}) => { let s = (LANG_STRINGS[currentLang] || LANG_STRINGS.en)[key] || key; for (const p in params) s = s.replace(`{${p}}`, params[p]); return s; };
        const updateAllUIText = () => { document.querySelectorAll('[data-lang-key]').forEach(el => el.textContent = t(el.dataset.langKey)); document.querySelectorAll('.shop-item').forEach(i => { const u=i.dataset.unit; if(u&&UNIT_STATS[u])i.querySelector('span').textContent = `${t(u.toLowerCase())}(${UNIT_STATS[u].cost}G)`; }); updateUIElements(); };
		const GAME_CONFIG = { INITIAL_GOLD: 50, BASE_HP: 100, GOLD_PER_TURN: 10, ITEM_SPAWN_RATE: 4, ITEM_GOLD_AMOUNT: 20 };
        const UNIT_STATS = { 'Base':{hp:GAME_CONFIG.BASE_HP},'Pawn':{hp:30,attack:12,cost:10,moveRange:1,attackRange:1},'Rook':{hp:50,attack:20,cost:25,moveRange:3,attackRange:1},'Knight':{hp:35,attack:15,cost:20,moveRange:2,attackRange:1},'Bishop':{hp:20,attack:25,cost:30,moveRange:2,attackRange:4},'Queen':{hp:45,attack:30,cost:60,moveRange:2,attackRange:2},'Skeleton':{hp:10,attack:5,cost:0,moveRange:1,attackRange:1},};
        let gameState = {};
        const boardEl = document.getElementById('game-board');
        function resetGameState() { gameState = { board: Array(8).fill(null).map(()=>Array(8).fill(null).map(()=>({unit:null,terrain:null,item:null}))), currentPlayer:'player1', turn:1, players:{'player1':{gold:GAME_CONFIG.INITIAL_GOLD,faction:'human'},'cpu':{gold:GAME_CONFIG.INITIAL_GOLD,faction:'human'}}, gameOver:false, selectedUnit:null, unitToBuy:null, cpuDifficulty:'medium', isTutorial:false}; }
        function initBoard() { boardEl.innerHTML=''; for(let y=0;y<8;y++)for(let x=0;x<8;x++){const tile=document.createElement('div');tile.className=`tile ${(x+y)%2===0?'light':'dark'}`;tile.dataset.x=x;tile.dataset.y=y;boardEl.appendChild(tile);} }
        function startGame() { resetGameState(); gameState.players.player1.faction=selectedPlayerFaction; gameState.players.cpu.faction=selectedCpuFaction; gameState.board[7][3].unit={type:'Base',owner:'player1',hp:GAME_CONFIG.BASE_HP}; gameState.board[0][3].unit={type:'Base',owner:'cpu',hp:GAME_CONFIG.BASE_HP}; gameState.board[7][4].unit={type:'Base',owner:'player1',hp:GAME_CONFIG.BASE_HP}; gameState.board[0][4].unit={type:'Base',owner:'cpu',hp:GAME_CONFIG.BASE_HP}; generateTerrain(); renderGame(); updateAllUIText(); Logger.clear(); Logger.add(t('log_turn_start',{player:t('player1')}),'system'); if(gameState.isTutorial)TutorialManager.start(); }
        function generateTerrain() { for(let i=0;i<10;i++){ let x=Math.floor(Math.random()*8),y=Math.floor(Math.random()*4)+2; if(!gameState.board[y][x].terrain) gameState.board[y][x].terrain='forest'; } for(let i=0;i<8;i++){ let x=Math.floor(Math.random()*8),y=Math.floor(Math.random()*4)+2; if(!gameState.board[y][x].terrain) gameState.board[y][x].terrain='bush'; } }
        const isHidden = (x,y,viewer) => { const cell = gameState.board[y][x]; if(cell.terrain !== 'bush' || !cell.unit || cell.unit.owner === viewer) return false; for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++) { const nx=x+dx, ny=y+dy; if(nx>=0&&nx<8&&ny>=0&&ny<8&&gameState.board[ny][nx].unit?.owner===viewer) return false; } return true; };
        function renderGame() { boardEl.querySelectorAll('.unit-wrapper, .item-gold').forEach(el=>el.remove()); for(let y=0;y<8;y++)for(let x=0;x<8;x++){ const c=gameState.board[y][x], tile=boardEl.querySelector(`.tile[data-x="${x}"][data-y="${y}"]`); if(!tile)continue; tile.className=`tile ${(x+y)%2===0?'light':'dark'}`; if(c.terrain)tile.classList.add(c.terrain); if(c.item?.type==='gold')tile.innerHTML+='<div class="item-gold">üí∞</div>'; if(c.unit){const w=document.createElement('div');w.className='unit-wrapper'; if(isHidden(x,y,gameState.currentPlayer)) w.classList.add('hidden'); w.style.transform=`translate(${x*90}px,${y*90}px)`;w.dataset.x=x;w.dataset.y=y;const u=document.createElement('div');u.className=`unit ${c.unit.owner}`;u.textContent={'Pawn':'‚ôü','Rook':'‚ôú','Knight':'‚ôû','Bishop':'‚ôù','Queen':'‚ôõ','Skeleton':'üíÄ','Base':'üè∞'}[c.unit.type]||'?';w.appendChild(u);const m=UNIT_STATS[c.unit.type].hp;if(c.unit.type!=='Base')w.innerHTML+=`<div class="unit-hp-bar"><div class="unit-hp-bar-inner" style="width:${c.unit.hp/m*100}%"></div></div>`;else w.innerHTML+=`<div class="base-health ${c.unit.owner}">${c.unit.hp}/${m}</div>`;boardEl.appendChild(w);} } }
        function updateUIElements() { if(!gameState||!gameState.players)return; document.getElementById('turn-info').textContent=t('turnInfo',{turn:gameState.turn,player:t(gameState.currentPlayer)}); document.getElementById('difficulty-info').textContent=`${t('difficultyLabel')}: ${t(gameState.cpuDifficulty)}`; document.getElementById('p1-gold').textContent=gameState.players.player1.gold; document.getElementById('cpu-gold').textContent=gameState.players.cpu.gold; }
        async function placeUnit(type,x,y,owner){const cost=UNIT_STATS[type].cost;gameState.players[owner].gold-=cost;gameState.board[y][x].unit={type,owner,hp:UNIT_STATS[type].hp,attack:UNIT_STATS[type].attack,hasMoved:false,hasAttacked:false,summonedThisTurn:true};Logger.add(t('log_buy',{player:t(owner),unit:t(type.toLowerCase())}),owner);updateUIElements();renderGame();await new Promise(r=>setTimeout(r,50));const e=boardEl.querySelector(`.unit-wrapper[data-x="${x}"][data-y="${y}"]`);if(e){e.style.setProperty('--start-x',`${x*90}px`);e.style.setProperty('--start-y',`${y*90}px`);e.classList.add('summoning');await new Promise(r=>setTimeout(r,400));e.classList.remove('summoning');}if(gameState.isTutorial)TutorialManager.advance('place');}
        async function moveUnit(sel,x,y){const e=boardEl.querySelector(`.unit-wrapper[data-x="${sel.x}"][data-y="${sel.y}"]`);if(e){e.style.transform=`translate(${x*90}px, ${y*90}px)`;await new Promise(r=>setTimeout(r,500));}const u=sel.unit;gameState.board[y][x].unit=u;gameState.board[sel.y][sel.x].unit=null;u.hasMoved=true;u.hasAttacked=true;Logger.add(t('log_move',{player:t(u.owner),unit:t(u.type.toLowerCase()),x,y}),u.owner);const c=gameState.board[y][x];if(c.item?.type==='gold'){gameState.players[u.owner].gold+=c.item.amount;Logger.add(t('log_gold_item',{player:t(u.owner),gold:c.item.amount}),u.owner);c.item=null;updateUIElements();}renderGame();if(gameState.isTutorial)TutorialManager.advance('move');}
        async function attackUnit(atk,tgt,x,y){const e=boardEl.querySelector(`.unit-wrapper[data-x="${atk.x}"][data-y="${atk.y}"]`);if(e){e.style.setProperty('--start-x',`${atk.x*90}px`);e.style.setProperty('--start-y',`${atk.y*90}px`);e.style.setProperty('--attack-x',`${((x-atk.x)*30)+(atk.x*90)}px`);e.style.setProperty('--attack-y',`${((y-atk.y)*30)+(atk.y*90)}px`);e.classList.add('attacking');await new Promise(r=>setTimeout(r,600));e.classList.remove('attacking');}const dmg=atk.unit.attack,p=document.createElement('div');p.className='damage-popup';p.textContent=`-${dmg}`;p.style.left=`${x*90+30}px`;p.style.top=`${y*90+20}px`;boardEl.appendChild(p);setTimeout(()=>p.remove(),1000);tgt.hp-=dmg;Logger.add(t('log_attack',{attackerUnit:t(atk.unit.type.toLowerCase()),targetUnit:t(tgt.type.toLowerCase()),damage:dmg}),atk.unit.owner);atk.unit.hasAttacked=true;atk.unit.hasMoved=true;if(tgt.hp<=0){const te=boardEl.querySelector(`.unit-wrapper[data-x="${x}"][data-y="${y}"]`);if(te){te.style.setProperty('--start-x',`${x*90}px`);te.style.setProperty('--start-y',`${y*90}px`);te.classList.add('dying');await new Promise(r=>setTimeout(r,800));}handleUnitDeath(tgt,x,y);}renderGame();if(gameState.isTutorial)TutorialManager.advance('attack');}
        function handleUnitDeath(unit,x,y){Logger.add(t('log_destroy',{unit:t(unit.type.toLowerCase())}),'system');const owner=unit.owner;gameState.board[y][x].unit=null;if(gameState.players[owner].faction==='undead'&&unit.type!=='Base'&&unit.type!=='Skeleton')gameState.board[y][x].unit={type:'Skeleton',owner,hp:10,attack:5,hasMoved:false,hasAttacked:false,summonedThisTurn:true};if(unit.type==='Base')endGame(owner==='player1'?'cpu':'player1');}
        const Logger={entries:[],add(msg,cls='system'){this.entries.unshift({message:msg,ownerClass:cls});if(this.entries.length>50)this.entries.pop();this.render();},render(){document.getElementById('game-log-content').innerHTML=this.entries.map(e=>`<div class="log-entry ${e.ownerClass}">${e.message}</div>`).join('');},clear(){this.entries=[];this.render();}};
        const AI={getPurchasePriority(){const t=gameState.turn,d=gameState.cpuDifficulty;if(d==='hard')return t<=3?['Knight','Pawn']:['Queen','Rook','Bishop','Knight'];if(d==='easy')return t<=5?['Pawn','Knight']:['Rook','Knight','Pawn'];return t<=4?['Pawn','Knight']:['Queen','Rook','Bishop'];},async takeTurn(){if(gameState.gameOver)return;Logger.add("ü§ñ CPUÍ∞Ä Ï†ÑÎûµÏùÑ Íµ¨ÏÉÅ Ï§ëÏûÖÎãàÎã§...",'cpu');await new Promise(r=>setTimeout(r,500));let threats=[];for(let y=0;y<3;y++)for(let x=0;x<8;x++)if(gameState.board[y][x].unit?.owner==='player1')threats.push(gameState.board[y][x].unit);if(threats.length>0){Logger.add(t('log_defense'),'cpu');const defenders=[];for(let y=0;y<8;y++)for(let x=0;x<8;x++)if(gameState.board[y][x].unit?.owner==='cpu')defenders.push({unit:gameState.board[y][x].unit,x,y});for(const d of defenders){const attacks=this.getValidAttacks(d.unit.type,d.x,d.y,'cpu').filter(a=>threats.includes(gameState.board[a.y][a.x].unit));if(attacks.length>0){const targetCoord=attacks[0];const targetUnit=gameState.board[targetCoord.y][targetCoord.x].unit;await attackUnit(d,targetUnit,targetCoord.x,targetCoord.y);await new Promise(r=>setTimeout(r,800));if(gameState.gameOver)return;}}}const ownUnits=[];for(let y=0;y<8;y++)for(let x=0;x<8;x++)if(gameState.board[y][x].unit?.owner==='cpu'&&!gameState.board[y][x].unit.hasAttacked)ownUnits.push({unit:gameState.board[y][x].unit,x,y});for(const u of ownUnits){const attacks=this.getValidAttacks(u.unit.type,u.x,u.y,'cpu').map(a=>({...a,target:gameState.board[a.y][a.x].unit}));if(attacks.length>0){let target;if(gameState.cpuDifficulty==='hard')target=attacks.sort((a,b)=>a.target.hp-b.target.hp)[0];else if(gameState.cpuDifficulty==='easy')target=attacks[Math.floor(Math.random()*attacks.length)];else target=attacks.sort((a,b)=>UNIT_STATS[b.target.type].cost-UNIT_STATS[a.target.type].cost)[0];await attackUnit(u,target.target,target.x,target.y);await new Promise(r=>setTimeout(r,800));if(gameState.gameOver)return;}}for(const u of ownUnits){if(u.unit.hasMoved||u.unit.summonedThisTurn)continue;const moves=this.getValidMoves(u.unit.type,u.x,u.y,'cpu');if(moves.length>0){const bestMove=moves.sort((a,b)=>b.y-a.y)[0];await moveUnit(u,bestMove.x,bestMove.y);await new Promise(r=>setTimeout(r,500));}}const unitToBuy=this.getPurchasePriority().find(type=>UNIT_STATS[type].cost<=gameState.players.cpu.gold);if(unitToBuy){const pos=[];for(let y=0;y<3;y++)for(let x=0;x<8;x++)if(!gameState.board[y][x].unit)pos.push({x,y});if(pos.length>0){Logger.add(`ü§ñ CPU: ${t(unitToBuy.toLowerCase())} Íµ¨Îß§`,'cpu');const p=pos[Math.floor(Math.random()*pos.length)];await placeUnit(unitToBuy,p.x,p.y,'cpu');await new Promise(r=>setTimeout(r,800));}}endTurn();},getValidMoves(type,x,y,owner){const m=[],p={'Pawn':owner==='player1'?[[0,-1]]:[[0,1]],'Rook':[[0,1],[0,-1],[1,0],[-1,0]],'Knight':[[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]],'Bishop':[[1,1],[1,-1],[-1,1],[-1,-1]],'Queen':[[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]],'Skeleton':[[0,1],[0,-1],[1,0],[-1,0]]}[type]||[];for(const[dx,dy]of p)for(let i=1;i<=UNIT_STATS[type].moveRange;i++){const nX=x+dx*i,nY=y+dy*i;if(nX<0||nX>=8||nY<0||nY>=8)break;const c=gameState.board[nY][nX];if(!c.unit&&c.terrain!=='mountain')m.push({x:nX,y:nY});else break;if(type==='Pawn'||type==='Knight')break;}return m;},getValidAttacks(type,x,y,owner){const a=[],p=type==='Pawn'?(owner==='player1'?[[1,-1],[-1,-1]]:[[1,1],[-1,1]]):this.getValidMoves(type,x,y,owner).map(m=>[m.x-x,m.y-y]);for(const[dx,dy]of p)for(let i=1;i<=UNIT_STATS[type].attackRange;i++){const nX=x+dx*i,nY=y+dy*i;if(nX<0||nX>=8||nY<0||nY>=8)break;if(isHidden(nX,nY,owner))continue;const t=gameState.board[nY][nX].unit;if(t){if(t.owner!==owner)a.push({x:nX,y:nY});break;}if(type==='Pawn'||type==='Knight')break;}return a;}};
        boardEl.addEventListener('click',async e=>{const tile=e.target.closest('.tile');if(!tile||gameState.gameOver||gameState.currentPlayer!=='player1')return;const x=parseInt(tile.dataset.x),y=parseInt(tile.dataset.y);if(gameState.unitToBuy){if(y>=6&&!gameState.board[y][x].unit){await placeUnit(gameState.unitToBuy,x,y,'player1');gameState.unitToBuy=null;clearHighlights();}return;}const unit=gameState.board[y][x].unit;if(gameState.selectedUnit){const s=gameState.selectedUnit;if(!s.unit.hasMoved&&!s.unit.summonedThisTurn&&AI.getValidMoves(s.unit.type,s.x,s.y,'player1').some(m=>m.x===x&&m.y===y))await moveUnit(s,x,y);else if(!s.unit.hasAttacked&&unit?.owner==='cpu'&&AI.getValidAttacks(s.unit.type,s.x,s.y,'player1').some(a=>a.x===x&&a.y===y))await attackUnit(s,unit,x,y);gameState.selectedUnit=null;clearHighlights();}else if(unit?.owner==='player1'&&unit.type!=='Base'){gameState.selectedUnit={unit,x,y};showValidActions(unit,x,y);if(gameState.isTutorial)TutorialManager.advance('select');}});
        const showValidActions=(unit,x,y)=>{clearHighlights();boardEl.querySelector(`.tile[data-x="${x}"][data-y="${y}"]`)?.classList.add('selected');if(!unit.hasMoved&&!unit.summonedThisTurn)AI.getValidMoves(unit.type,x,y,unit.owner).forEach(m=>boardEl.querySelector(`.tile[data-x="${m.x}"][data-y="${m.y}"]`)?.classList.add('valid-move'));if(!unit.hasAttacked)AI.getValidAttacks(unit.type,x,y,unit.owner).forEach(a=>boardEl.querySelector(`.tile[data-x="${a.x}"][data-y="${a.y}"]`)?.classList.add('valid-attack'));};
        const clearHighlights=()=>{boardEl.querySelectorAll('.selected,.valid-move,.valid-attack,.spawn').forEach(t=>t.classList.remove('selected','valid-move','valid-attack','spawn'));};
        document.getElementById('end-turn-btn').addEventListener('click',()=>{if(gameState.currentPlayer==='player1'&&!gameState.gameOver)endTurn();});
        function endTurn(){Logger.add(t('log_turn_end',{player:t(gameState.currentPlayer)}),'system');for(let r of gameState.board)for(let c of r)if(c.unit?.owner===gameState.currentPlayer)c.unit={...c.unit,hasMoved:false,hasAttacked:false,summonedThisTurn:false};gameState.currentPlayer=gameState.currentPlayer==='player1'?'cpu':'player1';gameState.players[gameState.currentPlayer].gold+=GAME_CONFIG.GOLD_PER_TURN;if(gameState.currentPlayer==='player1'){gameState.turn++;if(gameState.turn>1&&gameState.turn%GAME_CONFIG.ITEM_SPAWN_RATE===0){const e=[];for(let y=1;y<7;y++)for(let x=0;x<8;x++)if(!gameState.board[y][x].unit&&!gameState.board[y][x].item&&gameState.board[y][x].terrain!=='mountain')e.push({x,y});if(e.length>0){const{x,y}=e[Math.floor(Math.random()*e.length)];gameState.board[y][x].item={type:'gold',amount:GAME_CONFIG.ITEM_GOLD_AMOUNT};Logger.add(t('log_item_spawn'),'system');}}}else{setTimeout(()=>AI.takeTurn(),1000);}Logger.add(t('log_turn_start',{player:t(gameState.currentPlayer)}),'system');clearHighlights();updateUIElements();renderGame();}
        const endGame = (winner) => { if(gameState.gameOver)return; gameState.gameOver=true; document.getElementById('game-over-title').textContent=t('wins',{winner:t(winner)}); document.getElementById('game-over-modal').style.display='flex'; };
        document.querySelectorAll('.shop-item').forEach(i=>{i.addEventListener('click',()=>{if(gameState.currentPlayer!=='player1'||gameState.gameOver)return;const type=i.dataset.unit;if(gameState.players.player1.gold<UNIT_STATS[type].cost)return;gameState.unitToBuy=type;clearHighlights();for(let y=6;y<8;y++)for(let x=0;x<8;x++)if(!gameState.board[y][x].unit)boardEl.querySelector(`.tile[data-x="${x}"][data-y="${y}"]`)?.classList.add('spawn');if(gameState.isTutorial)TutorialManager.advance('buy');});i.addEventListener('mouseenter',()=>{const type=i.dataset.unit,unit=UNIT_STATS[type],tt=document.getElementById('unit-tooltip');tt.style.left=`${i.getBoundingClientRect().left-220}px`;tt.style.top=`${i.getBoundingClientRect().top}px`;tt.innerHTML=`<h4>${t(type.toLowerCase())}</h4><div>${Object.entries({hp:unit.hp,attack:unit.attack,moveRange:unit.moveRange,attackRange:unit.attackRange,cost:`${unit.cost}G`}).map(([k,v])=>`<div class="stat-row"><span>${t(k)}:</span><span>${v}</span></div>`).join('')}</div>`;tt.style.display='block';});i.addEventListener('mouseleave',()=>{document.getElementById('unit-tooltip').style.display='none';});});
        const TutorialManager={steps:[{id:'buy',msg:'t_buy'},{id:'place',msg:'t_place'},{id:'select',msg:'t_select'},{id:'move',msg:'t_move'},{id:'attack',msg:'t_attack'},{id:'end',msg:'t_end'}],current:-1,isActive:false,start(){this.isActive=true;this.current=0;this.show();},advance(action){if(!this.isActive||action!==this.steps[this.current].id)return;this.current++;if(this.current>=this.steps.length)this.end();else this.show();},show(){alert(t(this.steps[this.current].msg));},end(){this.isActive=false;gameState.isTutorial=false;alert(t('t_end'));}};
        let selectedPlayerFaction='human',selectedCpuFaction='undead';
        const showModal = id => {document.querySelectorAll('.modal-overlay').forEach(m=>m.style.display='none');document.getElementById(id).style.display='flex';updateAllUIText();};
        document.querySelectorAll('[data-lang]').forEach(b=>b.addEventListener('click',e=>{currentLang=e.target.dataset.lang;showModal('tutorial-modal');}));
        document.getElementById('start-tutorial-btn').addEventListener('click',()=>{gameState.isTutorial=true;showModal('faction-modal');});
        document.getElementById('skip-tutorial-btn').addEventListener('click',()=>{gameState.isTutorial=false;showModal('faction-modal');});
        document.querySelectorAll('.faction-btn').forEach(b=>b.addEventListener('click',e=>{document.querySelectorAll('.faction-btn').forEach(btn=>btn.classList.remove('selected'));e.currentTarget.classList.add('selected');selectedPlayerFaction=e.currentTarget.dataset.faction;}));
        document.getElementById('confirm-faction-btn').addEventListener('click',()=>showModal('difficulty-modal'));
        document.querySelectorAll('.difficulty-btn').forEach(b=>b.addEventListener('click',e=>{gameState.cpuDifficulty=e.target.dataset.difficulty;document.getElementById('difficulty-modal').style.display='none';startGame();}));
        document.getElementById('restart-btn').addEventListener('click',()=>showModal('lang-modal'));
        initBoard(); showModal('lang-modal');
    });
    </script>
</body>
</html>
