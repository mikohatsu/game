<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í¬ë ˆí”„í„°ì˜ ê³µë°©: Lv. 30 í™•ì¥ ì—ë””ì…˜</title>
    <style>
        /* --- CSS ìŠ¤íƒ€ì¼ --- */
        * { box-sizing: border-box; user-select: none; }
        body { 
            font-family: 'Segoe UI', sans-serif; margin: 0; height: 100vh; 
            display: flex; overflow: hidden; background-color: #f0f0f0; color: #333;
        }

        /* ë ˆì´ì•„ì›ƒ */
        #palette-area { width: 260px; background: #fff; border-right: 1px solid #ddd; padding: 15px; display: flex; flex-direction: column; overflow-y: auto; }
        #workspace-area { flex: 1; background: #e0e0e0; position: relative; display: flex; flex-direction: column; }
        #stage-area { width: 420px; background: #f8f9fa; border-left: 1px solid #ccc; padding: 20px; display: flex; flex-direction: column; align-items: center; }

        /* HUD */
        #hud-bar { height: 50px; background: #34495e; color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
        .hud-info { font-weight: bold; font-size: 14px; }
        .limit-badge { background: #e74c3c; padding: 5px 10px; border-radius: 15px; font-size: 12px; margin-left: 10px; transition: background 0.3s; }
        .limit-ok { background: #2ecc71; }

        /* ë¸”ë¡ ìŠ¤íƒ€ì¼ */
        #code-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px 0; background-color: #e0e0e0;}
        #clear-btn { background: #95a5a6; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        #clear-btn:hover { background: #7f8c8d; }

        #code-canvas { flex: 1; padding: 20px; overflow: auto; background-image: radial-gradient(#ccc 1px, transparent 1px); background-size: 20px 20px; }
        .block { padding: 10px 12px; margin-bottom: 5px; border-radius: 4px; color: white; font-size: 13px; font-weight: 600; cursor: grab; box-shadow: 0 2px 4px rgba(0,0,0,0.15); display: flex; align-items: center; position: relative; min-width: 180px; }
        .block:active { cursor: grabbing; }
        .block-motion { background-color: #4c97ff; border: 1px solid #3373cc; }
        .block-control { background-color: #ffab19; border: 1px solid #cf8b17; }
        .container-block { flex-direction: column; align-items: flex-start; }
        .container-header { 
            width: 100%; 
            display: flex; 
            justify-content: space-between; /* â­ UX ê°œì„ : ìš”ì†Œ ê°„ ê°„ê²© ìµœëŒ€í™” */
            align-items: center; 
        }
        .container-content { min-height: 40px; min-width: 90%; margin-top: 5px; margin-left: 15px; background: rgba(0,0,0,0.1); border-radius: 4px; padding: 5px; border: 2px dashed rgba(255,255,255,0.4); }
        
        /* â­ UX ê°œì„ : ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .remove-btn { 
            font-size: 16px; 
            color: white; 
            cursor: pointer; 
            margin-left: auto; 
            padding: 0 5px; 
            opacity: 0.7;
            transition: opacity 0.2s, transform 0.2s;
        }

        .remove-btn:hover {
            opacity: 1;
            transform: scale(1.1);
            color: #e74c3c; 
        }
        /* --- */

        /* ë§µ & íƒ€ì¼ */
        .map-grid {
            display: grid; 
            gap: 2px; background: #333; border: 4px solid #333; margin: 20px 0; border-radius: 4px;
        }
        .tile { width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; position: relative; background: #95a5a6; }
        .tile.W { background: #34495e; background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, #2c3e50 5px, #2c3e50 10px); } 
        .tile.R::after { content: 'ğŸ’'; font-size: 24px; position: absolute; } 
        .tile.R { background: #f1c40f; } 
        .tile.G { background: #2ecc71; } /* Goal Open */
        .tile.G.locked { background: #7f8c8d; cursor: not-allowed; } 
        .tile.G::after { content: 'ğŸš©'; font-size: 24px; }
        .tile.G.locked::after { content: 'ğŸ”’'; font-size: 24px; opacity: 0.5; }
        
        /* ìƒˆë¡œìš´ íƒ€ì¼ ìŠ¤íƒ€ì¼ */
        .tile.H { background: #c0392b; } /* í•¨ì • */
        .tile.H::after { content: 'ğŸ•³ï¸'; font-size: 24px; }
        .tile.P { background: #8e44ad; } /* ê²©í„´ í•¨ì • */
        .tile.P::after { content: 'ğŸ”„'; font-size: 24px; }
        .tile.B { background: #e67e22; border: 3px dashed #d35400; } /* ë¶€ì„œì§€ëŠ” ì¹¸ */
        .tile.B::after { content: 'ğŸ§±'; font-size: 24px; opacity: 0.7; }

        /* ë§µ ìˆ¨ê¸°ê¸° ìŠ¤íƒ€ì¼ */
        .map-grid.hidden-map .tile { background-color: #555; border: 1px solid #444; }
        .map-grid.hidden-map .tile.T, .map-grid.hidden-map .tile.W { background-color: #555; background-image: none; border: 1px solid #444; }
        
        .robot { width: 40px; height: 40px; background: #3498db; border-radius: 8px; position: absolute; z-index: 5; display: flex; justify-content: center; align-items: center; color: white; font-size: 20px; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }

        /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ê·¸ë£¹ */
        #game-controls { width: 100%; display: flex; gap: 10px; margin-top: 5px; }
        #run-btn, .action-btn { flex-grow: 1; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; background: #2ecc71; color: white; cursor: pointer; transition: transform 0.1s; }
        #run-btn:disabled, .action-btn:disabled { background: #95a5a6; cursor: not-allowed; }
        #run-btn:active, .action-btn:active { transform: scale(0.98); }
        .action-btn.retry { background: #3498db; }
        .action-btn.next { background: #f39c12; }
        
        #console-log { width: 100%; height: 150px; background: #222; color: #0f0; font-family: monospace; font-size: 12px; padding: 10px; margin-top: 15px; border-radius: 5px; overflow-y: auto; }
        
        /* ë ˆë²¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .level-nav { display: flex; width: 100%; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .level-nav button { background: #fff; border: 1px solid #ccc; padding: 5px 10px; cursor: pointer; border-radius: 4px; }

        /* ë“œë˜ê·¸ íŒíŠ¸ */
        .drop-hint { height: 40px; border: 2px dashed #999; background: rgba(0,0,0,0.05); margin-bottom: 5px; border-radius: 4px; }
        .block.active-exec { box-shadow: 0 0 0 3px #fff, 0 0 15px #f1c40f; z-index: 100; transform: scale(1.05); }

        /* --- ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ìƒˆë¡œ ì¶”ê°€) --- */
        #unlock-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s;
        }

        #unlock-modal {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            animation: bounceIn 0.5s ease-out;
        }

        #unlock-modal h2 {
            color: #f39c12;
            margin-top: 0;
        }

        #unlocked-block-display {
            display: inline-flex !important; /* ëª¨ë‹¬ ë‚´ì—ì„œ ì¤‘ì•™ ì •ë ¬ */
            margin: 15px auto;
            font-size: 18px;
            padding: 15px 25px;
        }

        #unlocked-block-desc {
            font-size: 14px;
            color: #555;
            margin-bottom: 20px;
            min-height: 40px;
        }

        #unlock-modal button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }
        #unlock-modal button:hover {
            background: #2980b9;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.8); opacity: 0; }
            60% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }

    </style>
</head>
<body>

    <div id="palette-area">
        <h3 style="color:#555;">ğŸ§© ë¶€í’ˆ ì°½ê³  (í•´ê¸ˆë¨)</h3>
        <div id="palette-content">
            </div>
        <div style="margin-top:auto; font-size:12px; color:#888;">
            Tip: ë§µ í¬ê¸°ëŠ” 5x5ë¡œ ê³ ì •ë©ë‹ˆë‹¤.
        </div>
    </div>

    <div id="workspace-area">
        <div id="hud-bar">
            <span class="hud-info">í˜„ì¬ ë¯¸ì…˜: <span id="level-name-display">Lv.1</span></span>
            <div style="display:flex; align-items:center;">
                <span id="resource-status" class="hud-info" style="margin-right:15px;">ğŸ’ 0/0</span>
                <span id="block-counter" class="limit-badge limit-ok">ë¸”ë¡: 0 / âˆ</span>
            </div>
        </div>
        <div id="code-header">
            <p style="color:#666; font-size:14px; margin:0;">ì—¬ê¸°ì— ë¸”ë¡ì„ ì¡°í•©í•˜ì„¸ìš”</p>
            <button id="clear-btn" onclick="clearCodeCanvas()">ëª¨ë‘ ì œê±°</button>
        </div>
        <div id="code-canvas">
            <p style="text-align:center; color:#999; margin-top:50px; pointer-events:none;">
                ë¸”ë¡ì„ ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”.
            </p>
        </div>
    </div>

    <div id="stage-area">
        <div class="level-nav">
            <button onclick="changeLevel(-1)">â—€ ì´ì „</button>
            <strong id="level-indicator">Level 1</strong>
            <button id="next-level" onclick="changeLevel(1)">ë‹¤ìŒ â–¶</button>
        </div>
        <p id="level-desc" style="font-size:13px; color:#666; text-align:center; min-height:40px;">ì„¤ëª…</p>
        
        <div class="map-grid" id="game-map"></div>
        
        <div id="game-controls">
            <button id="run-btn" onclick="runGame()">ğŸš© ì‹¤í–‰í•˜ê¸°</button>
            <button id="retry-btn" class="action-btn retry" onclick="resetGame()" style="display:none;">ğŸ” ì¬ì‹œë„</button>
            <button id="next-btn" class="action-btn next" onclick="changeLevel(1)" style="display:none;">ë‹¤ìŒ ë‹¨ê³„ â–¶</button>
        </div>
        <div id="console-log"></div>
    </div>

    <div id="unlock-modal-overlay" style="display:none;">
        <div id="unlock-modal">
            <h2>âœ¨ ìƒˆë¡œìš´ ë¸”ë¡ í•´ê¸ˆ!</h2>
            <div id="unlocked-block-display" class="block block-motion"></div>
            <p id="unlocked-block-desc"></p>
            <button onclick="closeUnlockModal()">í™•ì¸</button>
        </div>
    </div>

    <script>
        /* --- í•µì‹¬ ìƒìˆ˜ --- */
        const MAP_SIZE = 5; 
        const DIR_VECS = [{x:0,y:-1}, {x:1,y:0}, {x:0,y:1}, {x:-1,y:0}]; // ë¶ë™ë‚¨ì„œ

        /* --- ë¸”ë¡ ì •ì˜ (í•´ê¸ˆìš© ë§ˆìŠ¤í„° ëª©ë¡) --- */
        const ALL_BLOCK_TYPES = [
            { id: 'move', type: 'motion', label: '1ì¹¸ ì „ì§„', usage: 'ë¡œë´‡ì´ ë°”ë¼ë³´ëŠ” ë°©í–¥ìœ¼ë¡œ í•œ ì¹¸ ì´ë™í•©ë‹ˆë‹¤.' },
            { id: 'turn_left', type: 'motion', label: 'ì¢ŒíšŒì „ â†º', usage: 'ë¡œë´‡ì´ ì‹œê³„ ë°˜ëŒ€ ë°©í–¥(ì™¼ìª½)ìœ¼ë¡œ 90ë„ íšŒì „í•©ë‹ˆë‹¤.' },
            { id: 'turn_right', type: 'motion', label: 'ìš°íšŒì „ â†»', usage: 'ë¡œë´‡ì´ ì‹œê³„ ë°©í–¥(ì˜¤ë¥¸ìª½)ìœ¼ë¡œ 90ë„ íšŒì „í•©ë‹ˆë‹¤.' },
            { id: 'loop', type: 'control', label: 'ë²ˆ ë°˜ë³µ', isContainer: true, hasInput: true, def: 3, usage: 'ë‚´ë¶€ì˜ ë¸”ë¡ë“¤ì„ ì •í•´ì§„ íšŸìˆ˜ë§Œí¼ ë°˜ë³µ ì‹¤í–‰í•©ë‹ˆë‹¤.' },
            { id: 'collect', type: 'motion', label: 'ìì› ì¤ê¸° ğŸ’', usage: 'í˜„ì¬ ì¹¸ì— ìì›(R)ì´ ìˆìœ¼ë©´ ìˆ˜ì§‘í•˜ê³  ë§µì—ì„œ ì œê±°í•©ë‹ˆë‹¤.' },
            { id: 'jump', type: 'motion', label: 'ì í”„ (ë²½ ë„˜ê¸°)', usage: 'ì•ì— ë²½ì´ ìˆìœ¼ë©´ 2ì¹¸ ì í”„í•˜ì—¬ ë„˜ê³ , ì—†ìœ¼ë©´ 1ì¹¸ ì „ì§„í•©ë‹ˆë‹¤.' },
            { id: 'if_wall', type: 'control', label: 'ë§Œì•½ ì•ì— ë²½ì´ë©´', isContainer: true, usage: 'ë¡œë´‡ ì „ë°©ì— ë²½(W)ì´ ìˆì„ ê²½ìš°ì—ë§Œ ë‚´ë¶€ ë¸”ë¡ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.' },
            { id: 'if_resource', type: 'control', label: 'ë§Œì•½ ìì›ì´ë¼ë©´?', isContainer: true, usage: 'ë¡œë´‡ì´ í˜„ì¬ ì„œ ìˆëŠ” ì¹¸ì— ìì›(R)ì´ ìˆì„ ê²½ìš°ì—ë§Œ ë‚´ë¶€ ë¸”ë¡ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.' }, 
            { id: 'u_turn', type: 'motion', label: 'ë’¤ë¡œ ëŒê¸° (U-Turn)', usage: 'ë¡œë´‡ì´ 180ë„ ë°©í–¥ì„ ì „í™˜í•©ë‹ˆë‹¤. (ì¢ŒíšŒì „ 2íšŒì™€ ë™ì¼)' },
            { id: 'break_loop', type: 'control', label: 'ë°˜ë³µ ì¦‰ì‹œ ì¢…ë£Œ (Break)', usage: 'í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ Loop ë¸”ë¡ì„ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ê³  Loop ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.' },
            { id: 'wait', type: 'motion', label: '1ìŠ¤í… ëŒ€ê¸° â±ï¸', usage: 'ë¡œë´‡ì´ í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì•„ë¬´ í–‰ë™ ì—†ì´ 1 ê²Œì„ ìŠ¤í…ì„ ë³´ëƒ…ë‹ˆë‹¤. (íƒ€ì´ë° ì¡°ì ˆìš©)' }, 
        ];

        /* --- ë°ì´í„°: ë ˆë²¨ ë””ìì¸ (LEVELS ë°°ì—´ì€ ì—¬ê¸°ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤) --- */
        const LEVELS = [
            // Lv. 1~3: íŠœí† ë¦¬ì–¼ ë° íšŒì „ í•´ê¸ˆ
            { name: "Lv.1 ì§ì§„ íŠœí† ë¦¬ì–¼", desc: "ì²« ê±¸ìŒì…ë‹ˆë‹¤. ì „ì§„ë§Œ í•˜ì„¸ìš”.", maxBlocks: 4, start: {x:0, y:2, dir:1}, map: [['T','T','T','T','T'], ['T','W','W','W','T'], ['S','T','G','T','T'], ['T','W','W','W','T'], ['T','T','T','T','T']], reqAllRes: false, isHidden: false, unlockedBlocks: ['move'] },
            { name: "Lv.2 íšŒì „ í•´ê¸ˆ", desc: "ì¢Œ/ìš° íšŒì „ì„ ë°°ìš°ì„¸ìš”.", maxBlocks: 4, start: {x:1, y:4, dir:1}, map: [['T','T','T','T','T'], ['T','W','T','W','T'], ['T','W','G','W','T'], ['T','W','T','W','T'], ['T','S','T','T','T']], reqAllRes: false, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right'] },
            { name: "Lv.3 íšŒì „ ì¡°í•©", desc: "íšŒì „ ë¸”ë¡ë§Œìœ¼ë¡œ ë³µì¡í•œ ê²½ë¡œë¥¼ ëš«ìœ¼ì„¸ìš”.", maxBlocks: 5, start: {x:0, y:4, dir:1}, map: [['T','T','T','T','T'], ['T','W','W','W','T'], ['T','T','T','T','T'], ['W','T','G','W','T'], ['S','T','W','W','T']], reqAllRes: false, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right'] },
            // Lv. 4~5: ë£¨í”„ í•´ê¸ˆ (Loop ê°•ì œ)
            { name: "Lv.4 ë£¨í”„ íŠœí† ë¦¬ì–¼", desc: "ë°˜ë³µ ë¸”ë¡ì´ í•´ê¸ˆë˜ì—ˆìŠµë‹ˆë‹¤. 3ê°œ ì œí•œ!", maxBlocks: 3, start: {x:0, y:4, dir:1}, map: [['G','T','T','T','T'], ['T','W','W','W','T'], ['T','T','T','T','T'], ['T','W','W','W','T'], ['S','T','T','T','T']], reqAllRes: false, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop'] },
            { name: "Lv.5 ë‚˜ì„ í˜• ë£¨í”„", desc: "4ê°œì˜ ë‚˜ì„ í˜• íšŒì „ì„ ë°˜ë³µìœ¼ë¡œ í’€ì–´ë³´ì„¸ìš”.", maxBlocks: 7, start: {x:0, y:0, dir:1}, map: [['S','T','T','T','T'], ['W','W','W','W','T'], ['G','T','T','W','T'], ['T','W','T','W','T'], ['T','T','T','T','T']], reqAllRes: false, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop'] },
            // Lv. 6~8: ìì›, ì í”„ í•´ê¸ˆ
            { name: "Lv.6 ìì›ê³¼ ì í”„", desc: "ìì› ì¤ê¸°ì™€ ì í”„ ë¸”ë¡ì´ í•´ê¸ˆë˜ì—ˆìŠµë‹ˆë‹¤.", maxBlocks: 8, start: {x:0, y:4, dir:0}, map: [['T','W','W','W','G'], ['T','W','T','W','W'], ['T','W','T','W','T'], ['W','W','W','W','W'], ['S','W','T','W','R']], reqAllRes: true, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump'] },
            { name: "Lv.7 í•‘ê±° íŠ¸ë©", desc: "ë²½ì´ ì—‡ê°ˆë¦½ë‹ˆë‹¤. ì í”„ì™€ íšŒì „ ì¡°í•©ì´ í•„ìš”í•©ë‹ˆë‹¤.", maxBlocks: 10, start: {x:0, y:4, dir:0}, map: [['G','W','T','W','T'], ['T','W','T','W','T'], ['T','W','T','W','T'], ['T','W','T','W','T'], ['S','T','R','T','T']], reqAllRes: true, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump'] },
            { name: "Lv.8 ìì› ìµœì í™”", desc: "3ê°œ ìì› ìˆ˜ì§‘ í›„ ê³¨ì¸. ë¸”ë¡ ìˆ˜ë¥¼ ìµœëŒ€í•œ ì¤„ì´ì„¸ìš”.", maxBlocks: 10, start: {x:0, y:2, dir:0}, map: [['R','T','T','T','R'], ['W','W','W','W','W'], ['S','T','T','T','T'], ['W','W','W','W','W'], ['G','T','T','T','R']], reqAllRes: true, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump'] },
            // Lv. 9~15: íƒì§€ ë¶ˆê°€ (Hidden) ë° ì¡°ê±´ë¬¸ í•´ê¸ˆ
            { name: "Lv.9 ì¡°ê±´ë¬¸ í•´ê¸ˆ", desc: "ë²½/ìì› í™•ì¸ ì¡°ê±´ë¬¸ í•´ê¸ˆ. ë²½ì„ ë§Œë‚˜ë©´ íšŒì „í•˜ì„¸ìš”.", maxBlocks: 10, start: {x:0, y:4, dir:0}, map: [['G','T','W','T','R'], ['T','T','W','T','T'], ['T','T','T','T','T'], ['T','W','W','W','T'], ['S','T','T','T','T']], reqAllRes: true, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource'] },
            { name: "Lv.10 ë¯¸ë¡œ (Hidden)", desc: "ë§µì´ ì•ˆ ë³´ì…ë‹ˆë‹¤. ë²½ì„ ì°¾ì•„ ê²½ë¡œë¥¼ ë§Œë“œì„¸ìš”.", maxBlocks: 10, start: {x:0, y:4, dir:0}, map: [['G','T','T','T','T'], ['T','W','W','W','T'], ['T','T','T','T','T'], ['T','W','W','W','T'], ['S','T','T','T','T']], reqAllRes: false, isHidden: true, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource'] },
            { name: "Lv.11 ìì› ìë™íƒìƒ‰", desc: "ë³´ì´ì§€ ì•ŠëŠ” ë§µì—ì„œ ìì›ì„ ëª¨ë‘ ìˆ˜ì§‘í•˜ì„¸ìš”.", maxBlocks: 10, start: {x:0, y:4, dir:0}, map: [['T','R','T','R','G'], ['W','W','W','W','T'], ['T','T','T','T','T'], ['T','W','R','W','T'], ['S','T','T','T','T']], reqAllRes: true, isHidden: true, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource'] },
            { name: "Lv.12 ë¯¸ë¡œ 2", desc: "ì¡°ê±´ë¬¸ì„ í™œìš©í•œ íš¨ìœ¨ì ì¸ ë¯¸ë¡œ íƒìƒ‰ì´ í•„ìš”í•©ë‹ˆë‹¤.", maxBlocks: 10, start: {x:0, y:4, dir:0}, map: [['G','W','T','W','T'], ['T','W','T','W','T'], ['T','W','T','W','T'], ['T','W','T','W','T'], ['S','T','R','T','T']], reqAllRes: true, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource'] },
            { name: "Lv.13 í•‘ê±° íŠ¸ë© (Hidden 2)", desc: "ì¡°ê±´ë¬¸ê³¼ ë°˜ë³µì„ ì´ìš©í•´ ìˆ¨ê²¨ì§„ ë§µì„ í†µê³¼í•˜ì„¸ìš”.", maxBlocks: 10, start: {x:0, y:4, dir:0}, map: [['T','T','R','T','G'], ['T','W','W','W','T'], ['T','T','T','T','T'], ['T','W','W','W','T'], ['S','T','R','T','T']], reqAllRes: true, isHidden: true, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource'] },
            { name: "Lv.14 ì í”„ ìë™í™”", desc: "ì í”„ì™€ If_Wallì„ ì´ìš©í•´ ì¥ì• ë¬¼ì„ ê±´ë„ˆë©° ì „ì§„í•˜ì„¸ìš”.", maxBlocks: 10, start: {x:0, y:4, dir:0}, map: [['G','W','R','W','T'], ['T','W','T','W','T'], ['T','W','T','W','T'], ['T','W','T','W','T'], ['S','T','T','T','T']], reqAllRes: true, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource'] },
            { name: "Lv.15 ì¤‘ê°„ ë³´ìŠ¤ (Hidden)", desc: "ë‚œì´ë„ ê¸‰ìƒìŠ¹! ëª¨ë“  ê²ƒì„ ì‚¬ìš©í•´ ìµœì í™”í•˜ì„¸ìš”.", maxBlocks: 10, start: {x:0, y:2, dir:1}, map: [['G','R','R','R','T'], ['W','W','W','W','T'], ['S','T','T','T','T'], ['T','W','W','W','W'], ['R','T','T','T','T']], reqAllRes: true, isHidden: true, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource'] },
            // Lv. 16~20: U-Turn, Break Loop í•´ê¸ˆ (ìµœì í™”)
            { name: "Lv.16 U-Turn í•´ê¸ˆ", desc: "ë’¤ë¡œ ëŒê¸°(U-Turn)ê°€ í•´ê¸ˆ. íšŒì „ 2ë¸”ë¡ì„ 1ë¸”ë¡ìœ¼ë¡œ ëŒ€ì²´í•˜ì„¸ìš”.", maxBlocks: 6, start: {x:0, y:4, dir:0}, map: [['G','T','T','T','T'], ['T','W','W','W','T'], ['T','T','T','T','T'], ['T','W','W','W','T'], ['S','T','T','T','T']], reqAllRes: false, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource', 'u_turn'] },
            { name: "Lv.17 Break Loop í•´ê¸ˆ", desc: "ë°˜ë³µ ì¦‰ì‹œ ì¢…ë£Œê°€ í•´ê¸ˆ. ë¬´í•œ ë£¨í”„ë¥¼ ë©ˆì¶”ì„¸ìš”.", maxBlocks: 8, start: {x:0, y:4, dir:1}, map: [['T','T','T','T','T'], ['R','W','W','W','G'], ['T','T','R','T','T'], ['T','W','W','W','W'], ['S','R','T','T','T']], reqAllRes: false, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource', 'u_turn', 'break_loop'] },
            { name: "Lv.18 ìµœì í™” ë¯¸ë¡œ (Hidden 3)", desc: "ìˆ¨ê²¨ì§„ ë§µì—ì„œ ëª¨ë“  ë¸”ë¡ì„ ìµœì†Œí™”í•˜ì„¸ìš”.", maxBlocks: 7, start: {x:0, y:4, dir:0}, map: [['G','W','T','W','T'], ['T','W','R','W','R'], ['T','W','T','W','T'], ['R','W','R','W','T'], ['S','T','T','T','T']], reqAllRes: true, isHidden: true, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource', 'u_turn', 'break_loop'] },
            { name: "Lv.19 ë¬´í•œ ìˆœí™˜", desc: "Loopì™€ Breakë¥¼ í™œìš©í•´ ìµœë‹¨ ê²½ë¡œë¡œ íƒˆì¶œí•˜ì„¸ìš”.", maxBlocks: 8, start: {x:0, y:2, dir:1}, map: [['T','T','T','T','T'], ['W','W','W','W','T'], ['S','T','R','T','T'], ['T','W','W','W','G'], ['T','T','T','T','T']], reqAllRes: false, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource', 'u_turn', 'break_loop'] },
            { name: "Lv.20 ìµœì¢… ìµœì í™” (Hidden 4)", desc: "ìˆ¨ê²¨ì§„ ë§µì˜ ëª¨ë“  ê¸°ë¯¹ì„ íŒŒí›¼í•˜ê³  ê³¨ì¸.", maxBlocks: 7, start: {x:0, y:2, dir:1}, map: [['G','R','R','R','T'], ['W','W','W','W','T'], ['S','T','T','T','T'], ['T','W','W','W','W'], ['R','T','T','T','T']], reqAllRes: true, isHidden: true, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource', 'u_turn', 'break_loop'] },
            // Lv. 21~25: í•¨ì • ë° ëŒ€ê¸° í•´ê¸ˆ
            { name: "Lv.21 í•¨ì • ë°œê²¬ (H)", desc: "ë‹¿ìœ¼ë©´ ì‚¬ë§í•˜ëŠ” í•¨ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. í”¼í•˜ì„¸ìš”.", maxBlocks: 9, start: {x:0, y:4, dir:0}, map: [['G','T','T','T','T'], ['T','W','H','W','T'], ['T','W','T','W','T'], ['T','W','H','W','T'], ['S','T','T','T','T']], reqAllRes: false, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource', 'u_turn', 'break_loop'] },
            { name: "Lv.22 ê²©í„´ í•¨ì • (P)", desc: "ë°Ÿìœ¼ë©´ 180ë„ íšŒì „í•˜ëŠ” í•¨ì •ì„ í”¼í•´ ê³¨ì¸í•˜ì„¸ìš”.", maxBlocks: 8, start: {x:0, y:2, dir:1}, map: [['T','T','T','T','G'], ['W','W','W','W','T'], ['S','P','T','P','T'], ['W','W','W','W','T'], ['T','T','T','T','T']], reqAllRes: false, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource', 'u_turn', 'break_loop'] },
            { name: "Lv.23 ëŒ€ê¸° ë¸”ë¡ í•´ê¸ˆ", desc: "í•¨ì •ì„ í”¼í•˜ê¸° ìœ„í•´ 1ìŠ¤í… ë©ˆì¶”ëŠ” 'ëŒ€ê¸°' ë¸”ë¡ì´ í•´ê¸ˆë©ë‹ˆë‹¤.", maxBlocks: 9, start: {x:0, y:4, dir:0}, map: [['G','T','T','T','T'], ['T','W','H','W','T'], ['T','W','T','W','T'], ['T','W','H','W','T'], ['S','T','T','T','T']], reqAllRes: false, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource', 'u_turn', 'break_loop', 'wait'] },
            { name: "Lv.24 íƒ€ì´ë° (Hidden 5)", desc: "ìˆ¨ê²¨ì§„ í•¨ì •ë“¤ì„ ëŒ€ê¸° ë¸”ë¡ìœ¼ë¡œ í”¼í•´ íƒˆì¶œí•˜ì„¸ìš”.", maxBlocks: 10, start: {x:0, y:4, dir:0}, map: [['G','T','T','T','T'], ['T','W','H','W','T'], ['T','W','P','W','T'], ['T','W','H','W','T'], ['S','T','T','T','T']], reqAllRes: false, isHidden: true, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource', 'u_turn', 'break_loop', 'wait'] },
            { name: "Lv.25 í•¨ì • ê·¹ë³µ", desc: "ëª¨ë“  ì¢…ë¥˜ì˜ í•¨ì •ì„ í”¼í•˜ë©´ì„œ ìì›ì„ ëª¨ìœ¼ì„¸ìš”.", maxBlocks: 10, start: {x:0, y:2, dir:1}, map: [['T','R','H','R','T'], ['W','W','W','W','T'], ['S','P','T','P','G'], ['T','W','W','W','W'], ['T','T','T','T','T']], reqAllRes: true, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource', 'u_turn', 'break_loop', 'wait'] },
            // Lv. 26~30: ë¶€ì„œì§€ëŠ” ì¹¸ ë° ìµœì¢… ë‚œì´ë„
            { name: "Lv.26 ë¶€ì„œì§€ëŠ” ì¹¸ (B)", desc: "ë°Ÿê³  ì´ë™í•˜ë©´ ì‚¬ë¼ì ¸ ì¶”ë½ì‚¬í•©ë‹ˆë‹¤. ë°Ÿì€ í›„ ëŒ€ê¸°í•˜ì„¸ìš”.", maxBlocks: 9, start: {x:0, y:4, dir:0}, map: [['G','T','T','T','T'], ['T','B','W','B','T'], ['T','T','T','T','T'], ['T','B','W','B','T'], ['S','T','T','T','T']], reqAllRes: false, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource', 'u_turn', 'break_loop', 'wait'] },
            { name: "Lv.27 ì´ì¤‘ ìœ„í—˜", desc: "ë¶€ì„œì§€ëŠ” ì¹¸ê³¼ í•¨ì •ì„ í”¼í•´ ìì›ì„ ëª¨ë‘ ëª¨ìœ¼ì„¸ìš”.", maxBlocks: 11, start: {x:0, y:4, dir:0}, map: [['G','R','H','R','T'], ['B','W','W','W','T'], ['T','B','T','T','T'], ['T','W','W','W','T'], ['S','T','T','T','T']], reqAllRes: true, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource', 'u_turn', 'break_loop', 'wait'] },
            { name: "Lv.28 ë¶€ì„œì§€ëŠ” ë¯¸ë¡œ (Hidden 6)", desc: "ìˆ¨ê²¨ì§„ ë§µì—ì„œ ë–¨ì–´ì§€ì§€ ì•Šê³  íƒˆì¶œí•˜ì„¸ìš”.", maxBlocks: 10, start: {x:0, y:4, dir:0}, map: [['G','T','T','T','T'], ['T','B','W','B','T'], ['T','T','T','T','T'], ['T','B','W','B','T'], ['S','T','T','T','T']], reqAllRes: false, isHidden: true, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource', 'u_turn', 'break_loop', 'wait'] },
            { name: "Lv.29 ì§€ì˜¥ì˜ í•‘ê±° íŠ¸ë©", desc: "ëª¨ë“  ê¸°ë¯¹ì˜ ë³µí•©ì²´. ìµœì í™”ëœ ì¡°ê±´ë¬¸/ë°˜ë³µ/ëŒ€ê¸°ê°€ í•„ìš”í•©ë‹ˆë‹¤.", maxBlocks: 12, start: {x:0, y:4, dir:0}, map: [['G','R','H','R','T'], ['B','W','W','W','T'], ['T','P','T','T','T'], ['H','W','R','W','B'], ['S','T','T','T','T']], reqAllRes: true, isHidden: false, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource', 'u_turn', 'break_loop', 'wait'] },
            { name: "Lv.30 ğŸŒŸ ìµœì¢… ë³´ìŠ¤ ì±Œë¦°ì§€ (Hidden 7)", desc: "ë§µ ë””ìì¸ì˜ ëª¨ë“  ì•…ì˜ì™€ ìµœì í™”ê°€ ê²°í•©ëœ ìµœì¢… ë¯¸ì…˜ì…ë‹ˆë‹¤.", maxBlocks: 12, start: {x:0, y:4, dir:0}, map: [['G','R','H','B','T'], ['B','W','P','W','T'], ['T','T','T','T','T'], ['T','B','W','B','T'], ['S','R','H','R','T']], reqAllRes: true, isHidden: true, unlockedBlocks: ['move', 'turn_left', 'turn_right', 'loop', 'collect', 'jump', 'if_wall', 'if_resource', 'u_turn', 'break_loop', 'wait'] },
        ];

        /* --- ì „ì—­ ë³€ìˆ˜ --- */
        let curLevelIdx = 0;
        let curMapData = [];
        let robot = {};
        let totalResCount = 0;

        // â­ ìƒˆë¡œ ì¶”ê°€: í´ë¦¬ì–´ ìƒíƒœë¥¼ ì €ì¥í•  ë°°ì—´
        let clearedLevels = new Array(LEVELS.length).fill(false);

        /* --- ì´ˆê¸°í™” ë° UI --- */
        function init() {
            const savedData = localStorage.getItem('clearedLevels');
    
            if (savedData) {
                // ë°ì´í„°ê°€ ìˆìœ¼ë©´ JSON ë¬¸ìì—´ì„ ë°°ì—´ë¡œ íŒŒì‹±í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.
                log("[ë¡œê·¸] í˜„ì¬ í´ë¦¬ì–´ ìƒíƒœ : " + savedData, 'info')
                clearedLevels = JSON.parse(savedData);
            } else {
                // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ í˜„ì¬ ë ˆë²¨ ê°œìˆ˜ë§Œí¼ falseë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
                log("[ë¡œê·¸] ì €ì¥ëœ í´ë¦¬ì–´ ìƒíƒœê°€ ì—†ìŠµë‹ˆë‹¤. ì´ˆê¸°í™”ë©ë‹ˆë‹¤.", 'warn');
                clearedLevels = new Array(LEVELS.length).fill(false);
            }
            // LEVELS ë°°ì—´ì´ ë¹„ì–´ìˆì§€ ì•Šë‹¤ê³  ê°€ì •í•˜ê³  ë¡œë“œí•©ë‹ˆë‹¤.
            if (LEVELS.length > 0) {
                loadLevel(0);
            } else {
                log("[ì˜¤ë¥˜] LEVELS ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", 'err');
                document.getElementById('level-desc').innerText = "LEVELS ë°°ì—´ì„ ì½”ë“œì— ì‚½ì…í•´ì£¼ì„¸ìš”.";
            }

            setupDnD();
        }

        function clearCodeCanvas() {
            document.getElementById('code-canvas').innerHTML = '<p style="text-align:center; color:#999; margin-top:50px; pointer-events:none;">ë¸”ë¡ì„ ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”.</p>';
            updateHUD();
        }
        
        function renderPalette() {
            const container = document.getElementById('palette-content');
            container.innerHTML = '';
            
            const unlockedIds = LEVELS[curLevelIdx].unlockedBlocks;
            
            ALL_BLOCK_TYPES
                .filter(b => unlockedIds.includes(b.id)) // í•´ê¸ˆëœ ë¸”ë¡ë§Œ í•„í„°ë§
                .forEach(b => container.appendChild(createBlockEl(b)));
        }

        function createBlockEl(data) {
            const el = document.createElement('div');
            el.className = `block block-${data.type}`;
            el.dataset.id = data.id;
            el.draggable = true;
            
            if (data.isContainer) {
                el.classList.add('container-block');
                const header = document.createElement('div');
                header.className = 'container-header';
                
                if (data.hasInput) {
                    header.innerHTML = `<span>ğŸ” <input type="number" min="2" max="9" value="${data.def}" onclick="event.stopPropagation()"> ${data.label}</span>`;
                } else {
                    header.innerHTML = `<span>â“ ${data.label}</span>`;
                }
                el.appendChild(header);
                
                const content = document.createElement('div');
                content.className = 'container-content';
                el.appendChild(content);

            } else {
                el.innerText = data.label;
            }
            
            el.addEventListener('dragstart', handleDragStart);
            return el;
        }

        async function loadLevel(idx) {
            if (idx < 0 || idx >= LEVELS.length) return;
            
            // í˜„ì¬ ë ˆë²¨ê³¼ ë‹¤ìŒ ë ˆë²¨ì˜ í•´ê¸ˆ ë¸”ë¡ ëª©ë¡ì„ ë¹„êµ
            const prevLv = LEVELS[curLevelIdx] || { unlockedBlocks: [] };
            const nextLv = LEVELS[idx];

            const prevBlocks = new Set(prevLv.unlockedBlocks);
            const newBlocks = nextLv.unlockedBlocks.filter(b => !prevBlocks.has(b));
            
            curLevelIdx = idx; // ì¸ë±ìŠ¤ ë¨¼ì € ì—…ë°ì´íŠ¸
            
            if (newBlocks.length > 0 && !clearedLevels[idx]) {
                const newBlockId = newBlocks[newBlocks.length - 1];
                showUnlockModal(newBlockId);

                // ë²„íŠ¼ í´ë¦­ì„ ê¸°ë‹¤ë¦¬ëŠ” Promiseë¥¼ ë°”ë¡œ inlineìœ¼ë¡œ ìƒì„±
                await new Promise(resolve => {
                    document.querySelector('#unlock-modal button').onclick = () => {
                        closeUnlockModal();
                        resolve(); // í´ë¦­ ì‹œ resolve ì‹¤í–‰ë¨ â†’ await í•´ì œ
                    };
                });
            }
            proceedLoadLevel(idx);
        }

        function proceedLoadLevel(idx) {
            const lv = LEVELS[idx];

            curMapData = lv.map.map(row => [...row]);
            robot = { ...lv.start, inv: [], stepCount: 0 };
            
            totalResCount = 0;
            curMapData.forEach(row => row.forEach(cell => { if(cell === 'R') totalResCount++; }));

            document.getElementById('level-indicator').innerText = lv.name;
            document.getElementById('level-name-display').innerText = `Lv.${idx+1}`;
            document.getElementById('level-desc').innerText = lv.desc;
            document.getElementById('console-log').innerText = '';
            
            log(`[ì‹œìŠ¤í…œ] ${lv.name} ë¡œë“œ ì™„ë£Œ.`);
            log(`[ëª©í‘œ] ìì› ${totalResCount}ê°œ íšë“ í›„ ê³¨ì¸í•˜ì„¸ìš”.`);

            // ë¸”ë¡ íŒ”ë ˆíŠ¸ ì—…ë°ì´íŠ¸ (í•´ê¸ˆ ì ìš©)
            renderPalette();

            // ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
            document.getElementById('run-btn').style.display = 'block';
            document.getElementById('retry-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('next-level').style.visibility = clearedLevels[idx] ? 'visible' : 'hidden';

            updateHUD();
            renderMap();
        }

        // --- resetGame í•¨ìˆ˜ë„ proceedLoadLevel í˜¸ì¶œë¡œ ìˆ˜ì • ---
        function resetGame() {
            proceedLoadLevel(curLevelIdx);
        }

        function updateHUD() {
            const collected = robot.inv.length;
            const resText = document.getElementById('resource-status');
            resText.innerText = `ğŸ’ ${collected} / ${totalResCount}`;
            resText.style.color = (collected >= totalResCount || totalResCount === 0) ? '#2ecc71' : '#fff';

            const max = LEVELS[curLevelIdx].maxBlocks;
            const current = countBlocks(document.getElementById('code-canvas'));
            const counter = document.getElementById('block-counter');
            
            counter.innerText = `ë¸”ë¡: ${current} / ${max}`;
            if (current > max) {
                counter.className = 'limit-badge';
                counter.style.background = '#e74c3c';
                document.getElementById('run-btn').disabled = true;
                document.getElementById('run-btn').innerText = "ğŸš« ë¸”ë¡ ì´ˆê³¼!";
            } else {
                counter.className = 'limit-badge limit-ok';
                document.getElementById('run-btn').disabled = false;
                document.getElementById('run-btn').innerText = "ğŸš© ì‹¤í–‰í•˜ê¸°";
            }
        }

        function countBlocks(container) {
            let count = 0;
            const blocks = container.querySelectorAll(':scope > .block');
            blocks.forEach(b => {
                count++;
                const inner = b.querySelector('.container-content');
                if (inner) count += countBlocks(inner);
            });
            return count;
        }

        function renderMap() {
            const grid = document.getElementById('game-map');
            grid.innerHTML = '';
            
            const isHidden = LEVELS[curLevelIdx].isHidden;
            if (isHidden) {
                grid.classList.add('hidden-map');
            } else {
                grid.classList.remove('hidden-map');
            }
            
            grid.style.gridTemplateColumns = `repeat(${MAP_SIZE}, 60px)`; 
            grid.style.gridTemplateRows = `repeat(${MAP_SIZE}, 60px)`;
            grid.style.width = `${MAP_SIZE * 60 + (MAP_SIZE - 1) * 2 + 8}px`;

            const isGoalLocked = LEVELS[curLevelIdx].reqAllRes && (robot.inv.length < totalResCount);

            for(let y=0; y<MAP_SIZE; y++) {
                for(let x=0; x<MAP_SIZE; x++) {
                    const t = document.createElement('div');
                    let type = curMapData[y][x];
                    
                    if (type === 'G' && isGoalLocked) t.className = 'tile G locked';
                    else t.className = `tile ${type}`;
                    
                    if (robot.x === x && robot.y === y) {
                        const r = document.createElement('div');
                        r.className = 'robot';
                        r.style.transform = `rotate(${robot.dir * 90}deg)`;
                        r.innerText = 'â–²';
                        t.appendChild(r);
                    }
                    grid.appendChild(t);
                }
            }
        }

        function changeLevel(dir) {
            loadLevel(curLevelIdx + dir);
            clearCodeCanvas();
        }

        /* --- ê²Œì„ ë¡œì§ (ì‹¤í–‰) --- */
        async function runGame() {
            resetGame();
            
            const root = document.getElementById('code-canvas');
            const commands = parseBlocks(root);
            
            if (commands.length === 0) { log("âš ï¸ ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
            
            log("ğŸš€ í”„ë¡œê·¸ë¨ ì‹¤í–‰ ì¤‘...");
            document.getElementById('run-btn').disabled = true;
            
            const finalResult = await execute(commands);
            
            document.getElementById('run-btn').disabled = false;
            updateHUD();
            
            if (finalResult === false) {
                log("âŒ í”„ë¡œê·¸ë¨ì´ ì¹˜ëª…ì ì¸ ì˜¤ë¥˜ë¡œ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.", 'err');
                document.getElementById('run-btn').style.display = 'none';
                document.getElementById('retry-btn').style.display = 'block';
                document.getElementById('next-btn').style.display = 'none';
            } else if (finalResult === "success") {
                log("ğŸ‰ ë¯¸ì…˜ ì„±ê³µ! ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰", 'suc');

                // â­ í´ë¦¬ì–´ ìƒíƒœ ì—…ë°ì´íŠ¸
                clearedLevels[curLevelIdx] = true;
                // â­ 2. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í´ë¦¬ì–´ ëª©ë¡ ì €ì¥
                saveClearedStatus();

                document.getElementById('run-btn').style.display = 'none';
                document.getElementById('retry-btn').style.display = 'block';
                document.getElementById('next-btn').style.display = 'block';
            } else {
                log("âœ… ëª¨ë“  ëª…ë ¹ ì‹¤í–‰ ì™„ë£Œ (ëª©í‘œ ë¯¸ë‹¬ì„±)", 'warn');
                document.getElementById('run-btn').style.display = 'none';
                document.getElementById('retry-btn').style.display = 'block';
                document.getElementById('next-btn').style.display = 'none';
            }
        }

        function parseBlocks(container) {
            const cmds = [];
            const els = container.querySelectorAll(':scope > .block');
            els.forEach(el => {
                const id = el.dataset.id;
                if (id === 'loop' || id === 'if_wall' || id === 'if_resource') {
                    const cnt = id === 'loop' ? el.querySelector('input').value : null;
                    const children = parseBlocks(el.querySelector('.container-content'));
                    cmds.push({ type: id, count: parseInt(cnt), subs: children, el: el });
                } else {
                    cmds.push({ type: id, el: el });
                }
            });
            return cmds;
        }

        async function execute(cmds) {
            for (const cmd of cmds) {
                cmd.el.classList.add('active-exec');
                robot.stepCount++;

                let execResult = true;

                if (cmd.type === 'loop') {
                    log(`â†º ë£¨í”„: ${cmd.count}íšŒ ë°˜ë³µ`);
                    for (let i = 0; i < cmd.count; i++) {
                        const subResult = await execute(cmd.subs);
                        if (subResult === false) { execResult = false; break; }
                        if (subResult === "break") { execResult = true; break; }
                        if (subResult === "success") { execResult = "success"; break; }
                    }
                } 
                else if (cmd.type === 'if_wall') {
                    const front = getFrontPos();
                    if (isWall(front.x, front.y)) {
                        log("ğŸ§± ë²½ ë°œê²¬! ì¡°ê±´ë¬¸ ì‹¤í–‰");
                        execResult = await execute(cmd.subs);
                    } else { log("ğŸ’¨ ë²½ì´ ì—†ìŒ. í†µê³¼."); }
                } 
                else if (cmd.type === 'if_resource') {
                    if (curMapData[robot.y][robot.x] === 'R') {
                        log("ğŸ’ ìì› ë°œê²¬! ì¡°ê±´ë¬¸ ì‹¤í–‰");
                        execResult = await execute(cmd.subs);
                    } else { log("ë¹ˆ ì¹¸ì…ë‹ˆë‹¤. í†µê³¼."); }
                }
                else if (cmd.type === 'break_loop') {
                    log("ğŸš¨ ë°˜ë³µ ì¦‰ì‹œ ì¢…ë£Œ (Break Loop) ì‹¤í–‰");
                    execResult = 'break';
                }
                else {
                    const actionResult = processAction(cmd.type);
                    execResult = actionResult;
                }

                await new Promise(r => setTimeout(r, 500));
                cmd.el.classList.remove('active-exec');
                if (execResult === false) return false;
                if (execResult === "break") return "break";
                if (execResult === "success") return "success";
            }
            return true;
        }

        function processAction(act) {
            const vec = DIR_VECS[robot.dir];
            let nx = robot.x, ny = robot.y;
            let success = true;

            // 1. í˜„ì¬ ìœ„ì¹˜ ì²˜ë¦¬ (ì´ë™ ì „ì— ë°œíŒ ë¶€ì„œì§ ì²´í¬ ë° ìƒíƒœ ë³€ê²½)
            if (curMapData[robot.y][robot.x] === 'B') {
                curMapData[robot.y][robot.x] = 'T'; // ë¶€ì„œì§€ë©´ ì¼ë°˜ ì¹¸ìœ¼ë¡œ ë³€ê²½ (ë‹¤ìŒ ìŠ¤í…ì— ì¶”ë½ ì²´í¬)
                log("ğŸš§ ë°œíŒì´ ë¶€ì„œì§€ê¸° ì‹œì‘í•©ë‹ˆë‹¤...");
            }

            // 2. ì´ë™/íšŒì „ ê³„ì‚°
            if (act === 'move') {
                nx += vec.x; ny += vec.y;
                log("ì´ë™");
            } else if (act === 'jump') {
                const front = getFrontPos();
                if (isWall(front.x, front.y)) {
                    nx += vec.x * 2; ny += vec.y * 2;
                    log("ğŸ¦˜ ë²½ì„ ë„˜ì–´ 2ì¹¸ ì í”„!");
                } else {
                    nx += vec.x; ny += vec.y;
                    log("ğŸš¶ ë²½ ì—†ì´ 1ì¹¸ ì´ë™.");
                }
            } else if (act === 'turn_left') {
                robot.dir = (robot.dir + 3) % 4;
                log("ì¢ŒíšŒì „");
            } else if (act === 'turn_right') {
                robot.dir = (robot.dir + 1) % 4;
                log("ìš°íšŒì „");
            } else if (act === 'u_turn') {
                robot.dir = (robot.dir + 2) % 4;
                log("ìœ í„´");
            } else if (act === 'collect') {
                if (curMapData[robot.y][robot.x] === 'R') {
                    curMapData[robot.y][robot.x] = 'T';
                    robot.inv.push('R');
                    log("ğŸ’ ìì› íšë“!");
                } else {
                    log("ì—¬ê¸°ì—” ì•„ë¬´ê²ƒë„ ì—†ìŠµë‹ˆë‹¤.");
                }
                renderMap();
                updateHUD();
                return success; // ìˆ˜ì§‘ì€ ì´ë™ì´ ì—†ìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œ ì¢…ë£Œ
            } else if (act === 'wait') {
                log("â±ï¸ 1ìŠ¤í… ëŒ€ê¸°");
                // B íƒ€ì¼ì´ Të¡œ ë°”ë€ ìƒíƒœë¥¼ ë°˜ì˜í•˜ê¸° ìœ„í•´ ë§µë§Œ ì—…ë°ì´íŠ¸
                renderMap(); 
                return success; // ëŒ€ê¸°ëŠ” ì´ë™ì´ ì—†ìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œ ì¢…ë£Œ
            }

            // 3. ì´ë™ í™•ì • ë° ì¶©ëŒ ì²´í¬ (íšŒì „, ìˆ˜ì§‘, ëŒ€ê¸° ëª…ë ¹ì´ ì•„ë‹ ê²½ìš°ë§Œ)
            if (act !== 'wait' && act !== 'collect' && act.indexOf('turn') === -1 && act !== 'u_turn') {
                if (nx < 0 || nx >= MAP_SIZE || ny < 0 || ny >= MAP_SIZE) { 
                    log("ğŸ’¥ ë§µ ëì— ì¶©ëŒí•˜ì—¬ ì¶”ë½í–ˆìŠµë‹ˆë‹¤.", 'err'); 
                    return false;
                }
                if (curMapData[ny][nx] === 'W') { 
                    log("ğŸ’¥ ë²½ì— ì¶©ëŒí–ˆìŠµë‹ˆë‹¤.", 'err'); 
                    return false;
                }
                
                // â­ ì´ë™ í™•ì • (ë¡œë´‡ ìœ„ì¹˜ ì—…ë°ì´íŠ¸)
                robot.x = nx; 
                robot.y = ny;
            }

            // 4. ë„ì°© ì§€ì  ìƒíƒœ í™•ì¸ ë° ì´ë²¤íŠ¸ ì²˜ë¦¬ (ë¡œë´‡ì˜ ìƒˆ ìœ„ì¹˜ ê¸°ì¤€)
            const currentTile = curMapData[robot.y][robot.x];

            if (currentTile === 'G') {
                // â­ ë²„ê·¸ ìˆ˜ì •: ê³¨ì¸ ì²´í¬ëŠ” ì´ë™ì´ ì™„ë£Œëœ í›„ ìƒˆ ìœ„ì¹˜ì—ì„œ í™•ì¸ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
                const req = LEVELS[curLevelIdx].reqAllRes;
                if (req && robot.inv.length < totalResCount) {
                    log("ğŸ”’ ìì›ì´ ë¶€ì¡±í•´ì„œ ë¬¸ì´ ì—´ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤! (ê³¨ì¸ ì‹¤íŒ¨)", 'err');
                    return false;
                }
                renderMap();
                updateHUD();
                return "success"; // ì„±ê³µ
            } 
            
            // ì¹˜ëª…ì ì¸ í•¨ì • ì²´í¬ (G ì²´í¬ í›„)
            if (currentTile === 'B') {
                log("ğŸ“‰ ë°œíŒì´ ë¶€ì„œì§€ê³  ë–¨ì–´ì¡ŒìŠµë‹ˆë‹¤! ì‚¬ë§.", 'err');
                return false;
            } else if (currentTile === 'H') {
                log("â˜ ï¸ í•¨ì •ì— ë¹ ì¡ŒìŠµë‹ˆë‹¤! ì‚¬ë§.", 'err');
                return false;
            } else if (currentTile === 'P') {
                robot.dir = (robot.dir + 2) % 4; // 180ë„ íšŒì „
                log("â†©ï¸ ê²©í„´ í•¨ì • ë°œë™!");
            }
            
            renderMap();
            updateHUD();

            return success;
        }

        /* --- DnD Logic (UX ê°œì„  ë°˜ì˜) --- */
        let draggedItem = null;
        function handleDragStart(e) {
            draggedItem = this;
            e.dataTransfer.effectAllowed = 'copyMove';
            setTimeout(()=>this.classList.add('dragging'),0);
        }
        function setupDnD() {
            document.addEventListener('dragover', e => {
                e.preventDefault();
                const container = e.target.closest('#code-canvas, .container-content');
                if(!container) return;
                
                const after = getDragAfterElement(container, e.clientY);
                const hint = document.querySelector('.drop-hint') || document.createElement('div');
                hint.className = 'drop-hint';
                if(after) container.insertBefore(hint, after);
                else container.appendChild(hint);
            });
            document.addEventListener('drop', e => {
                e.preventDefault();
                const hint = document.querySelector('.drop-hint');
                if(!hint) return;
                
                let newItem;
                if (draggedItem.parentElement.id === 'palette-content') {
                    let id = draggedItem.dataset.id;
                    let data = ALL_BLOCK_TYPES.find(b=>b.id===id);
                    newItem = createBlockEl(data);

                    // â­ UX ê°œì„ : ì‚­ì œ ë²„íŠ¼ ë™ì  ìƒì„± ë° ì¶”ê°€
                    const rm = document.createElement('span');
                    rm.className='remove-btn';
                    rm.innerHTML='âœ–';
                    rm.title='ë¸”ë¡ ì‚­ì œ';
                    
                    rm.onclick = (ev)=>{ 
                        ev.stopPropagation(); 
                        newItem.remove(); 
                        updateHUD(); 
                    };
                    
                    if(data.isContainer) {
                        newItem.querySelector('.container-header').appendChild(rm);
                    } else {
                        newItem.appendChild(rm); 
                    }
                    // â­ ìˆ˜ì • ë

                } else {
                    newItem = draggedItem;
                }
                
                newItem.classList.remove('dragging');
                hint.replaceWith(newItem);
                updateHUD();
            });
            document.addEventListener('dragend', ()=>{
                const hint = document.querySelector('.drop-hint');
                if(hint) hint.remove();
                if(draggedItem) draggedItem.classList.remove('dragging');
            });
        }
        function getDragAfterElement(container, y) {
            const els = [...container.querySelectorAll(':scope > .block:not(.dragging)')];
            return els.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        /* --- ìœ í‹¸ë¦¬í‹° --- */
        function getFrontPos() {
            const vec = DIR_VECS[robot.dir];
            return { x: robot.x + vec.x, y: robot.y + vec.y };
        }

        function isValid(x, y) {
            return (x >= 0 && x < MAP_SIZE && y >= 0 && y < MAP_SIZE && curMapData[y][x] !== 'W');
        }

        function isWall(x, y) {
            if (x < 0 || x >= MAP_SIZE || y < 0 || y >= MAP_SIZE) return true;
            return curMapData[y][x] === 'W';
        }

        function log(msg, type) {
            const div = document.getElementById('console-log');
            const p = document.createElement('div');
            p.innerText = `> ${msg}`;
            
            if (type === 'err') p.style.color = '#ff5555'; 
            if (type === 'suc') p.style.color = '#ffff55'; 
            if (type === 'warn') p.style.color = '#f39c12'; 
            
            div.prepend(p); 
        }
        /**
         * ìƒˆë¡œìš´ ë¸”ë¡ í•´ê¸ˆ ëª¨ë‹¬ì„ í‘œì‹œí•©ë‹ˆë‹¤.
         * @param {string} blockId - í•´ê¸ˆëœ ë¸”ë¡ì˜ ID
         */
        function showUnlockModal(blockId) {
            const data = ALL_BLOCK_TYPES.find(b => b.id === blockId);
            if (!data) return;

            const modal = document.getElementById('unlock-modal-overlay');
            const display = document.getElementById('unlocked-block-display');
            const desc = document.getElementById('unlocked-block-desc');

            // ë¸”ë¡ ì‹œê°í™”
            display.className = `block block-${data.type}`;
            if (data.isContainer && data.hasInput) {
                display.innerText = `ğŸ” ${data.label}`;
            } else if (data.isContainer) {
                display.innerText = `â“ ${data.label}`;
            } else {
                display.innerText = data.label;
            }

            desc.innerText = data.usage;
            modal.style.display = 'flex';
        }

        /**
         * ë¸”ë¡ í•´ê¸ˆ ëª¨ë‹¬ì„ ë‹«ìŠµë‹ˆë‹¤.
         */
        function closeUnlockModal() {
            document.getElementById('unlock-modal-overlay').style.display = 'none';
            // ëª¨ë‹¬ì„ ë‹«ì€ í›„, ë¡œë”©í•  ë ˆë²¨ì´ ìˆë‹¤ë©´ ë‹¤ìŒ ë ˆë²¨ì„ ë¡œë“œ
            // í˜„ì¬ëŠ” loadLevel í•¨ìˆ˜ ë‚´ì—ì„œ ëª¨ë‹¬ì„ ë‹«ëŠ” í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
        }

        /**
         * í´ë¦¬ì–´ ìƒíƒœë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•©ë‹ˆë‹¤.
         */
        function saveClearedStatus() {
            try {
                // ë°°ì—´ì„ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.
                localStorage.setItem('clearedLevels', JSON.stringify(clearedLevels));
            } catch (e) {
                console.error("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì‹¤íŒ¨:", e);
            }
        }

        window.onload = init;
    </script>
</body>
</html>
