<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Project: DRONE (Definitive Edition)</title>
    <style>
        /* --- CORE --- */
        body { margin: 0; overflow: hidden; background: #0b0d10; font-family: 'Segoe UI', sans-serif; user-select: none; color: #e0f0ff; }
        canvas { display: block; cursor: crosshair; }
        .hidden { display: none !important; }
        .overlay { 
            position: absolute; top:0; left:0; width:100%; height:100%; 
            display:flex; flex-direction:column; align-items:center; justify-content:center; 
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); z-index: 100;
        }
        .interactive { pointer-events: auto; }

        /* --- HIGH-END UI THEME --- */
        .glass-panel {
            background: rgba(20, 30, 40, 0.7);
            border: 1px solid rgba(100, 200, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 12px;
        }
        .text-cyan { color: #00ffff; text-shadow: 0 0 10px rgba(0, 255, 255, 0.5); }
        .btn-action {
            padding: 15px 60px; font-size: 20px; font-weight: bold; letter-spacing: 2px;
            color: #fff; background: linear-gradient(135deg, #005588, #002244);
            border: 1px solid #00aaff; border-radius: 4px; cursor: pointer; transition: 0.2s;
            box-shadow: 0 0 15px rgba(0, 100, 255, 0.3);
        }
        .btn-action:hover { transform: scale(1.05); background: linear-gradient(135deg, #0077aa, #004466); box-shadow: 0 0 25px rgba(0, 200, 255, 0.6); }

        /* --- MAIN MENU --- */
        #main-menu .title { font-size: 72px; font-weight: 800; margin-bottom: 10px; letter-spacing: 5px; background: -webkit-linear-gradient(#fff, #00aaff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 20px #00aaff); }
        .data-display { font-size: 24px; padding: 10px 30px; border-radius: 30px; margin-bottom: 40px; border: 1px solid #005588; color: #00aaff; background: rgba(0,0,0,0.5); }
        
        .shop-container { display: flex; gap: 15px; margin-bottom: 40px; flex-wrap: wrap; max-width: 1200px; justify-content: center; }
        .shop-card {
            width: 160px; padding: 15px; text-align: center; cursor: pointer; transition: 0.3s;
            display: flex; flex-direction: column; justify-content: space-between; height: 140px;
        }
        .shop-card:hover { border-color: #00ffff; background: rgba(0, 100, 200, 0.2); transform: translateY(-5px); }
        .shop-card h3 { margin: 0; font-size: 18px; color: #fff; }
        .shop-card p { font-size: 12px; color: #aaa; margin: 10px 0; }
        .shop-card .cost { font-size: 16px; color: #00ffff; font-weight: bold; }
        .shop-card .lvl { font-size: 12px; color: #5588aa; margin-top: 5px; }

        /* --- HUD --- */
        #hud-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .hud-bottom {
            position: absolute; bottom: 0; width: 100%; height: 140px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            display: flex; justify-content: center; align-items: flex-end; padding-bottom: 25px;
        }
        
        /* Status Orbs */
        .status-group { display: flex; align-items: center; gap: 20px; margin-right: 40px; }
        .orb-frame {
            width: 80px; height: 80px; border-radius: 50%; background: #000; 
            border: 3px solid #334455; position: relative; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        .hp-liquid { position: absolute; bottom: 0; width: 100%; background: linear-gradient(to top, #800, #ff0044); transition: height 0.2s; box-shadow: 0 0 15px #ff0044; }
        
        /* Skill Slots */
        .skill-dock { display: flex; gap: 12px; align-items: flex-end; }
        .slot {
            width: 60px; height: 60px; background: rgba(10, 20, 30, 0.8); border: 1px solid #335577; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border-radius: 6px;
        }
        .slot.main { width: 70px; height: 70px; border-color: #00aaff; box-shadow: 0 0 10px rgba(0, 150, 255, 0.2); }
        .key-hint { position: absolute; top: 4px; left: 6px; font-size: 11px; color: #00aaff; font-weight: bold; }
        .slot-icon { font-size: 26px; filter: drop-shadow(0 0 5px rgba(255,255,255,0.5)); }
        .cd-overlay { 
            position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); 
            display: flex; justify-content: center; align-items: center; 
            color: #ff4444; font-weight: bold; font-size: 24px; border-radius: 6px;
        }

        .xp-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 6px; background: #111; }
        .xp-fill { height: 100%; width: 0%; background: #00aaff; box-shadow: 0 0 10px #00aaff; transition: width 0.3s; }

        /* --- SKILL TREE (TABBED) --- */
        #skill-window {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 900px; height: 650px; z-index: 150; display: flex; flex-direction: column;
        }
        .tab-header { display: flex; height: 60px; background: rgba(10, 15, 20, 0.95); border-bottom: 1px solid #335577; border-radius: 12px 12px 0 0; }
        .tab { 
            flex: 1; display: flex; align-items: center; justify-content: center; 
            font-size: 16px; color: #557799; cursor: pointer; transition: 0.2s; border-right: 1px solid rgba(255,255,255,0.05); font-weight: bold;
        }
        .tab:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .tab.active { background: rgba(0, 170, 255, 0.1); color: #00ffff; border-bottom: 3px solid #00ffff; }
        .tab.locked { opacity: 0.4; cursor: not-allowed; background: #050505; color: #333; }

        .tree-canvas { flex: 1; position: relative; background: radial-gradient(circle at center, #1b202b 0%, #0b0d10 100%); overflow: hidden; border-radius: 0 0 12px 12px; }
        svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        .node {
            position: absolute; width: 56px; height: 56px; background: #111; border: 2px solid #335577; border-radius: 50%;
            transform: translate(-50%, -50%); display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 5; transition: 0.2s; box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .node:hover { transform: translate(-50%, -50%) scale(1.2); border-color: #fff; z-index: 10; }
        .node.maxed { border-color: #00ffff; background: #003344; box-shadow: 0 0 20px rgba(0,255,255,0.4); }
        .node.skill-unlock { border-radius: 8px; width: 64px; height: 64px; border-color: #ffcc00; } /* Square for Skills */
        .node.locked { filter: grayscale(1); opacity: 0.2; pointer-events: none; }

        .tooltip {
            position: absolute; bottom: 70px; left: 50%; transform: translateX(-50%);
            width: 220px; background: rgba(0, 10, 20, 0.95); border: 1px solid #00aaff; padding: 12px;
            font-size: 13px; line-height: 1.4; text-align: center; display: none; z-index: 20;
            box-shadow: 0 5px 20px rgba(0,0,0,0.8); border-radius: 8px;
        }
        .node:hover .tooltip { display: block; }

        .sp-counter { position: absolute; bottom: 20px; right: 20px; text-align: right; }
        .sp-val { font-size: 32px; color: #00ffff; font-weight: bold; text-shadow: 0 0 10px #00ffff; }

        /* --- GAME OVER --- */
        .result-title { font-size: 80px; color: #ff3355; font-weight: 900; margin: 0; text-shadow: 0 0 30px rgba(255, 0, 0, 0.5); }
        .result-row { display: flex; justify-content: space-between; font-size: 24px; margin: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
        .soul-gained { font-size: 40px; color: #00ffff; margin: 30px 0; font-weight: bold; }

        /* --- NOTIFICATIONS --- */
        .toast {
            position: absolute; top: 15%; left: 50%; transform: translateX(-50%);
            font-size: 36px; color: #00ffff; font-weight: bold; text-shadow: 0 0 20px #00ffff;
            animation: slideUp 2s forwards; pointer-events: none; z-index: 200;
        }
        @keyframes slideUp { 0% { opacity: 0; transform: translate(-50%, 20px); } 15% { opacity: 1; transform: translate(-50%, 0); } 100% { opacity: 0; transform: translate(-50%, -50px); } }

    </style>
</head>
<body oncontextmenu="return false;">

    <!-- 1. MAIN MENU -->
    <div id="main-menu" class="overlay interactive">
        <div class="title">PROJECT: DRONE</div>
        <div class="data-display">DATA CHIPS: <span id="menu-souls">0</span></div>

        <!-- Difficulty Selection -->
        <div style="margin-bottom: 30px;">
            <div style="font-size: 18px; color: #00ffff; margin-bottom: 15px;">SELECT DIFFICULTY</div>
            <div id="difficulty-select" style="display: flex; gap: 15px; justify-content: center;"></div>
        </div>

        <div class="shop-container" id="shop-list"></div>

        <div style="display: flex; gap: 20px; justify-content: center; margin-top: 20px;">
            <button class="btn-action" onclick="Game.start()">INITIALIZE SYSTEM</button>
            <button class="btn-action" id="relic-btn" onclick="UI.openRelicGacha()" style="background: linear-gradient(135deg, #884400, #442200); display: none;">RELIC GACHA</button>
        </div>
    </div>

    <!-- 2. GAME OVER -->
    <div id="game-over" class="overlay hidden interactive">
        <h1 class="result-title">CRITICAL FAILURE</h1>
        <div class="glass-panel" style="width: 400px; padding: 40px; text-align: center;">
            <div class="result-row"><span>SYSTEM LEVEL</span><span id="end-lv">0</span></div>
            <div class="result-row"><span>HOSTILES PURGED</span><span id="end-kills" style="color:#ff3355">0</span></div>
            <div class="soul-gained">+<span id="end-souls">0</span> DATA</div>
            <button class="btn-action" onclick="Game.toMenu()" style="margin-top:20px; width:100%">REBOOT</button>
        </div>
    </div>

    <!-- 2.3. RELIC GACHA -->
    <div id="relic-gacha" class="overlay hidden interactive">
        <div class="glass-panel" style="width: 700px; padding: 40px;">
            <h2 style="text-align: center; font-size: 36px; color: #00ffff; margin-bottom: 20px;">RELIC GACHA</h2>
            <div style="text-align: center; font-size: 20px; color: #00aaff; margin-bottom: 30px;">Cost: 100 Data Chips</div>

            <div id="gacha-result" style="min-height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center;"></div>

            <div style="display: flex; gap: 20px; justify-content: center; margin-top: 30px;">
                <button class="btn-action" onclick="UI.rollRelic(1)" style="padding: 15px 40px;">ROLL x1</button>
                <button class="btn-action" onclick="UI.rollRelic(10)" style="padding: 15px 40px;">ROLL x10</button>
                <button class="btn-action" onclick="UI.closeRelicGacha()" style="padding: 15px 40px; background: linear-gradient(135deg, #555, #333);">CLOSE</button>
            </div>

            <div style="margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                <div style="font-size: 14px; color: #00ffff; margin-bottom: 10px;">RELIC INVENTORY</div>
                <div id="relic-inventory" style="max-height: 150px; overflow-y: auto; font-size: 12px; color: #aaa;"></div>
            </div>
        </div>
    </div>

    <!-- 2.5. JOB SELECTION -->
    <div id="job-select" class="overlay hidden interactive">
        <div class="glass-panel" style="width: 800px; padding: 40px;">
            <h2 style="text-align: center; font-size: 36px; color: #00ffff; margin-bottom: 30px;" id="job-title">SELECT JOB ADVANCEMENT</h2>
            <div id="job-options" style="display: flex; gap: 30px; justify-content: center;"></div>
        </div>
    </div>

    <!-- 3. SKILL WINDOW -->
    <div id="skill-window" class="glass-panel hidden interactive">
        <div class="tab-header">
            <div class="tab active" id="tab-1" onclick="UI.switchTab(1)">MK-I: SCOUT</div>
            <div class="tab locked" id="tab-2" onclick="UI.switchTab(2)">MK-II: ASSAULT</div>
            <div class="tab locked" id="tab-3" onclick="UI.switchTab(3)">MK-III: DESTROYER</div>
            <div class="tab locked" id="tab-4" onclick="UI.switchTab(4)">MK-X: OVERLORD</div>
        </div>
        <div class="tree-canvas">
            <svg id="tree-lines"></svg>
            <div id="tree-nodes"></div>
            
            <div class="sp-counter">
                <div style="font-size:12px; color:#579;">UNUSED MODULES</div>
                <div class="sp-val" id="tree-sp">0</div>
            </div>
            <div style="position: absolute; bottom: 20px; left: 20px; font-size: 12px; color: #579;">PRESS [K] TO CLOSE</div>
        </div>
    </div>

    <!-- 4. HUD -->
    <div id="hud-layer" class="hidden">
        <div style="position: absolute; top: 20px; left: 20px; text-align: left;">
            <div style="font-size: 32px; font-weight: 900; color: #00ffff; font-family: monospace;" id="hud-timer">15:00</div>
            <div style="font-size: 12px; color: #579; margin-top: 5px;">UNTIL FINAL BOSS</div>
        </div>

        <div style="position: absolute; top: 20px; right: 20px; text-align: right;">
            <div style="font-size: 24px; font-weight: bold; color: #fff;">LV. <span id="hud-lv" class="text-cyan">1</span></div>
            <div style="font-size: 14px; color: #00ffff; margin-top: 5px;" id="hud-job">DRONE OPERATOR</div>
            <div style="font-size: 12px; color: #579; margin-top: 3px;">[K] MODULES</div>
        </div>

        <div id="combo-display" style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); text-align: center; display: none;">
            <div style="font-size: 48px; font-weight: 900; color: #ffaa00; text-shadow: 0 0 20px #ff6600;" id="combo-number">0</div>
            <div style="font-size: 16px; color: #ff8800; font-weight: bold; margin-top: -10px;">COMBO</div>
            <div style="font-size: 14px; color: #00ffff; margin-top: 5px;" id="combo-mult">x1.0 CHIPS</div>
        </div>

        <div id="paused-indicator" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 64px; font-weight: 900; color: #00ffff; text-shadow: 0 0 30px #00ffff; display: none; pointer-events: none;">PAUSED</div>

        <div class="hud-bottom">
            <div class="status-group">
                <div class="orb-frame">
                    <div class="hp-liquid" id="hud-hp" style="height: 100%;"></div>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-weight: bold; font-size: 14px; text-shadow: 0 0 3px #000;" id="hud-hp-text">100%</div>
                </div>
            </div>
            
            <div class="skill-dock">
                <div class="slot"><span class="key-hint">L-CLICK</span><div class="slot-icon">ðŸ”«</div></div>
                <!-- Active Slots -->
                <div class="slot main"><span class="key-hint">R-CLICK</span><div class="slot-icon" id="icon-1">ðŸ”’</div><div class="cd-overlay" id="cd-1"></div></div>
                <div class="slot main"><span class="key-hint">SPACE</span><div class="slot-icon" id="icon-2">ðŸ”’</div><div class="cd-overlay" id="cd-2"></div></div>
                <div class="slot main"><span class="key-hint">R</span><div class="slot-icon" id="icon-3">ðŸ”’</div><div class="cd-overlay" id="cd-3"></div></div>
                <div class="slot main" style="border-color:#ff3355"><span class="key-hint">F</span><div class="slot-icon" id="icon-4">ðŸ”’</div><div class="cd-overlay" id="cd-4"></div></div>
            </div>
        </div>
        <div class="xp-bar"><div class="xp-fill" id="hud-xp"></div></div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
/**
 * PROJECT: DRONE (DEFINITIVE EDITION)
 * Highlights: Glassmorphism UI, Deep Skill Tree Graph, Persistent Save, Drone Action
 */

// --- ASSETS (SVG GRAPHICS) ---
const GFX = {
    drone: new Path2D("M-12,-12 L12,-12 L18,0 L12,12 L-12,12 L-18,0 Z"),
    arm: new Path2D("M0,0 L25,25 M0,0 L-25,25 M0,0 L25,-25 M0,0 L-25,-25"),
    blade: new Path2D("M-15,0 L15,0"),
    // Enemies
    scout: new Path2D("M0,-15 L10,5 L0,15 L-10,5 Z"),
    shooter: new Path2D("M0,-15 L15,10 L0,5 L-15,10 Z"),
    dasher: new Path2D("M0,-12 L8,-5 L12,5 L0,12 L-12,5 L-8,-5 Z"),
    sniper: new Path2D("M0,-20 L5,-5 L15,0 L5,5 L0,20 L-5,5 L-15,0 L-5,-5 Z"),
    tank: new Path2D("M-15,-15 L15,-15 L15,15 L-15,15 Z"),
    splitter: new Path2D("M0,-10 L8,0 L8,8 L0,10 L-8,8 L-8,0 Z"),
    boss: new Path2D("M-40,-30 L40,-30 L50,0 L30,40 L-30,40 L-50,0 Z"),
    finalboss: new Path2D("M-60,-50 L0,-70 L60,-50 L80,0 L60,50 L0,70 L-60,50 L-80,0 Z"),
    // FX
    bullet: new Path2D("M-2,-4 L2,-4 L2,4 L-2,4 Z")
};

// --- DATA: JOB SYSTEM ---
const JOBS = {
    // 1st Job (Lv 10) - Basic weapon, gain skill + passive
    tactician: { name: 'Tactician', desc: 'Skill specialist', icon: 'ðŸ§ ', weapon: 'basic', unlockLv: 10,
        skill: { name: 'Tactical Strike', desc: 'Precise burst shot', cd: 180, tier: 1 },
        passive: { cdr: 0.1, dmgMult: 0.2 } },
    berserker: { name: 'Berserker', desc: 'Attack & speed', icon: 'âš”ï¸', weapon: 'basic', unlockLv: 10,
        skill: { name: 'Rage Mode', desc: 'Double fire rate', cd: 300, tier: 1, duration: 150 },
        passive: { dmg: 3, dmgMult: 0.15 } },
    guardian: { name: 'Guardian', desc: 'Defense & sustain', icon: 'ðŸ›¡ï¸', weapon: 'basic', unlockLv: 10,
        skill: { name: 'Shield Dome', desc: 'Protective barrier', cd: 240, tier: 1, duration: 180 },
        passive: { hp: 50, regen: 1 } },

    // 2nd Job (Lv 30) - Weapon specialization
    gunner: { name: 'Gunner', desc: 'High fire rate', icon: 'ðŸ”«', weapon: 'minigun', parent: 'any', unlockLv: 30 },
    lancer: { name: 'Lancer', desc: 'Homing missiles', icon: 'ðŸš€', weapon: 'missile', parent: 'any', unlockLv: 30 },
    marksman: { name: 'Marksman', desc: 'Long range sniper', icon: 'ðŸŽ¯', weapon: 'sniper', parent: 'any', unlockLv: 30 },

    // 3rd Job (Lv 60) - Advanced specialization
    assault: { name: 'Assault', desc: 'Shotgun specialist', icon: 'ðŸ’¥', weapon: 'shotgun', parent: 'gunner', unlockLv: 60 },
    suppressor: { name: 'Suppressor', desc: 'Area denial', icon: 'ðŸŒªï¸', weapon: 'heavy', parent: 'gunner', unlockLv: 60 },
    juggernaut: { name: 'Juggernaut', desc: 'Tank destroyer', icon: 'ðŸ›¡ï¸', weapon: 'cannon', parent: 'gunner', unlockLv: 60 },

    striker: { name: 'Striker', desc: 'Rapid missiles', icon: 'âš¡', weapon: 'multi_missile', parent: 'lancer', unlockLv: 60 },
    artillery: { name: 'Artillery', desc: 'Bombardment', icon: 'ðŸ’£', weapon: 'rocket', parent: 'lancer', unlockLv: 60 },
    commander: { name: 'Commander', desc: 'Drone swarm', icon: 'ðŸ‘‘', weapon: 'drones', parent: 'lancer', unlockLv: 60 },

    sniper: { name: 'Sniper', desc: 'Ultra long range', icon: 'ðŸ”­', weapon: 'railgun', parent: 'marksman', unlockLv: 60 },
    hunter: { name: 'Hunter', desc: 'Crit master', icon: 'ðŸŽ¯', weapon: 'precision', parent: 'marksman', unlockLv: 60 },
    reaper: { name: 'Reaper', desc: 'Pierce multikill', icon: 'ðŸ’€', weapon: 'piercer', parent: 'marksman', unlockLv: 60 },

    // 4th Job (Lv 100) - Ultimate forms
    mastermind: { name: 'Mastermind', desc: 'Perfect execution', icon: 'ðŸŒŸ', weapon: 'railgun', parent: 'sniper', unlockLv: 100 },
    executioner: { name: 'Executioner', desc: 'Instant kills', icon: 'âš°ï¸', weapon: 'precision', parent: 'hunter', unlockLv: 100 },
    annihilator: { name: 'Annihilator', desc: 'Total destruction', icon: 'â˜ ï¸', weapon: 'piercer', parent: 'reaper', unlockLv: 100 },

    warmonger: { name: 'Warmonger', desc: 'Endless barrage', icon: 'ðŸ”¥', weapon: 'shotgun', parent: 'assault', unlockLv: 100 },
    warlord: { name: 'Warlord', desc: 'Domination', icon: 'ðŸ‘¹', weapon: 'heavy', parent: 'suppressor', unlockLv: 100 },
    titan: { name: 'Titan', desc: 'Unstoppable force', icon: 'âš™ï¸', weapon: 'cannon', parent: 'juggernaut', unlockLv: 100 },

    devastator: { name: 'Devastator', desc: 'Missile storm', icon: 'ðŸŒªï¸', weapon: 'multi_missile', parent: 'striker', unlockLv: 100 },
    apocalypse: { name: 'Apocalypse', desc: 'End of days', icon: 'ðŸ’€', weapon: 'rocket', parent: 'artillery', unlockLv: 100 },
    overlord: { name: 'Overlord', desc: 'Army commander', icon: 'ðŸ‘‘', weapon: 'drones', parent: 'commander', unlockLv: 100 }
};

// Weapon Attack Patterns
const WEAPONS = {
    basic: { rate: 15, dmg: 1, range: 350, spread: 0, bullets: 1, speed: 1 },

    // 2nd Job Weapons
    minigun: { rate: 5, dmg: 0.6, range: 300, spread: 0.15, bullets: 1, speed: 1.2 },
    missile: { rate: 30, dmg: 1.5, range: 500, spread: 0, bullets: 1, speed: 0.8, homing: true },
    sniper: { rate: 40, dmg: 3, range: 600, spread: 0, bullets: 1, speed: 1.5 },

    // 3rd Job - Gunner Weapons
    shotgun: { rate: 25, dmg: 0.8, range: 200, spread: 0.4, bullets: 6, speed: 1 },
    heavy: { rate: 8, dmg: 0.7, range: 350, spread: 0.2, bullets: 2, speed: 1, aoe: 80 },
    cannon: { rate: 60, dmg: 5, range: 400, spread: 0, bullets: 1, speed: 0.5, aoe: 150 },

    // 3rd Job - Lancer Weapons
    multi_missile: { rate: 20, dmg: 1.2, range: 500, spread: 0.1, bullets: 3, speed: 1, homing: true },
    rocket: { rate: 50, dmg: 4, range: 600, spread: 0, bullets: 1, speed: 0.8, aoe: 200 },
    drones: { rate: 10, dmg: 0.5, range: 400, spread: 0, bullets: 1, speed: 1, drone: true },

    // 3rd Job - Marksman Weapons
    railgun: { rate: 80, dmg: 8, range: 800, spread: 0, bullets: 1, speed: 2, pierce: true },
    precision: { rate: 30, dmg: 2.5, range: 600, spread: 0, bullets: 1, speed: 1.5, critBonus: 50 },
    piercer: { rate: 35, dmg: 2, range: 650, spread: 0, bullets: 1, speed: 1.3, pierce: true, chain: 3 }
};

// --- DATA: SKILL TREES (GRAPH) ---
// Structure: Root -> Branches. type 'active' unlocks HUD slots.
const TREES = {
    1: [ // MK-I
        { id: 't1_core', x: 450, y: 300, name: 'Core CPU', desc: 'Dmg +1', type: 'passive', stat: 'dmg', val: 1, max: 5 },
        { id: 't1_rail', parent: 't1_core', x: 450, y: 150, name: 'Railgun', desc: '[R-Click] High Dmg Beam', type: 'active', tier: 1, icon: 'âš¡', max: 1 },
        { id: 't1_hull', parent: 't1_core', x: 250, y: 400, name: 'Plating', desc: 'HP +20', type: 'passive', stat: 'hp', val: 20, max: 5 },
        { id: 't1_eng', parent: 't1_core', x: 650, y: 400, name: 'Thrusters', desc: 'Speed +5%', type: 'passive', stat: 'spd', val: 0.05, max: 5 },
        { id: 't1_reg', parent: 't1_hull', x: 150, y: 450, name: 'Auto-Repair', desc: 'Regen +0.1/s', type: 'passive', stat: 'regen', val: 0.1, max: 3 }
    ],
    2: [ // MK-II
        { id: 't2_core', x: 450, y: 300, name: 'Targeting', desc: 'Crit +5%', type: 'passive', stat: 'crit', val: 5, max: 5 },
        { id: 't2_shld', parent: 't2_core', x: 450, y: 150, name: 'Plasma Shield', desc: '[Space] Area Dmg + Shield', type: 'active', tier: 2, icon: 'ðŸ›¡ï¸', max: 1 },
        { id: 't2_vamp', parent: 't2_core', x: 300, y: 400, name: 'Nano-Siphon', desc: 'Heal +1 on hit', type: 'passive', stat: 'vamp', val: 1, max: 3 },
        { id: 't2_pwr', parent: 't2_core', x: 600, y: 400, name: 'Overclock', desc: 'Dmg +5%', type: 'passive', stat: 'dmgMult', val: 0.05, max: 5 }
    ],
    3: [ // MK-III
        { id: 't3_core', x: 450, y: 300, name: 'Reactor', desc: 'Cooldown -5%', type: 'passive', stat: 'cdr', val: 0.05, max: 3 },
        { id: 't3_emp', parent: 't3_core', x: 450, y: 150, name: 'EMP Blast', desc: '[R] Stun Enemies', type: 'active', tier: 3, icon: 'ðŸ’¥', max: 1 },
        { id: 't3_rng', parent: 't3_core', x: 450, y: 450, name: 'Optics', desc: 'Range +10%', type: 'passive', stat: 'range', val: 0.1, max: 5 }
    ],
    4: [ // MK-X
        { id: 't4_core', x: 450, y: 300, name: 'Singularity', desc: 'All Stats +10%', type: 'passive', stat: 'all', val: 10, max: 5 },
        { id: 't4_nuke', parent: 't4_core', x: 450, y: 150, name: 'Orbital Strike', desc: '[F] Screen Wipe', type: 'active', tier: 4, icon: 'â˜¢ï¸', max: 1 }
    ]
};

// Difficulty settings
const DIFFICULTIES = {
    normal: { name: 'NORMAL', hpMult: 1, dmgMult: 1, chipType: 'basic', chipColor: '#00aaff', unlock: true },
    hard: { name: 'HARD', hpMult: 2, dmgMult: 1.5, chipType: 'advanced', chipColor: '#ff00ff', unlock: false },
    veryhard: { name: 'VERY HARD', hpMult: 5, dmgMult: 2.5, chipType: 'superior', chipColor: '#ff8800', unlock: false },
    inferno: { name: 'INFERNO', hpMult: 10, dmgMult: 4, chipType: 'legendary', chipColor: '#ff0000', unlock: false }
};

// Relic system
const RELIC_TYPES = [
    { id: 'dmg', name: 'Attack Module', stat: 'dmg', value: 0.001, desc: 'Damage +0.1%' },
    { id: 'hp', name: 'Armor Plate', stat: 'hp', value: 0.001, desc: 'HP +0.1%' },
    { id: 'crit', name: 'Targeting Chip', stat: 'crit', value: 0.001, desc: 'Crit +0.1%' },
    { id: 'spd', name: 'Thruster Core', stat: 'spd', value: 0.001, desc: 'Speed +0.1%' },
    { id: 'range', name: 'Lens Array', stat: 'range', value: 0.001, desc: 'Range +0.1%' },
    { id: 'cdr', name: 'Coolant System', stat: 'cdr', value: 0.001, desc: 'CDR +0.1%' }
];

const RARITY = {
    common: { name: 'COMMON', chance: 0.60, color: '#aaa', mult: 1 },
    rare: { name: 'RARE', chance: 0.30, color: '#4af', mult: 2 },
    unique: { name: 'UNIQUE', chance: 0.07, color: '#fa4', mult: 5 },
    epic: { name: 'EPIC', chance: 0.03, color: '#f4f', mult: 10 }
};

const SHOP_DATA = [
    { id: 'start_dmg', name: 'WEAPON SYS', desc: 'Start Dmg +2', cost: 100, max: 10 },
    { id: 'start_hp', name: 'HULL UPGRADE', desc: 'Start HP +20', cost: 100, max: 10 },
    { id: 'chip_gain', name: 'DATA MINER', desc: 'Chips +10%', cost: 500, max: 5 },
    { id: 'start_crit', name: 'TARGETING SYS', desc: 'Start Crit +5%', cost: 200, max: 10 },
    { id: 'start_speed', name: 'THRUSTER MK2', desc: 'Start Speed +10%', cost: 150, max: 8 },
    { id: 'xp_gain', name: 'XP BOOSTER', desc: 'XP Gain +15%', cost: 400, max: 5 },
    { id: 'start_regen', name: 'AUTO-REPAIR', desc: 'Start Regen +0.2/s', cost: 300, max: 5 },
    { id: 'start_range', name: 'OPTICS CORE', desc: 'Start Range +15%', cost: 250, max: 6 }
];

// --- ENGINE ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const Save = {
    data: {
        souls: 0,
        upgrades: {},
        cleared: {},  // difficulty clear records
        relics: {},   // relic counts { 'dmg_common': 5, 'hp_rare': 2 }
        highestLevel: {} // highest level per difficulty
    },
    load() {
        const d = localStorage.getItem('DRONE_DEF_SAVE');
        if(d) this.data = JSON.parse(d);
        if(!this.data.cleared) this.data.cleared = {};
        if(!this.data.relics) this.data.relics = {};
        if(!this.data.highestLevel) this.data.highestLevel = {};
        SHOP_DATA.forEach(i => { if(!this.data.upgrades[i.id]) this.data.upgrades[i.id] = 0; });
    },
    save() { localStorage.setItem('DRONE_DEF_SAVE', JSON.stringify(this.data)); }
};

const Game = {
    state: 'MENU',
    paused: false,
    difficulty: 'normal',
    gameTime: 0,
    finalBossSpawned: false,
    player: null,
    enemies: [],
    bullets: [],
    particles: [],
    texts: [],
    camera: { x:0, y:0, shake:0 },
    atkTimer: 0,
    
    start() {
        Save.load();
        this.initPlayer();
        this.enemies = []; this.bullets = []; this.particles = []; this.texts = [];
        this.atkTimer = 0;
        this.gameTime = 0;
        this.finalBossSpawned = false;
        this.state = 'PLAY';
        
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('hud-layer').classList.remove('hidden');
        document.getElementById('game-over').classList.add('hidden');
        
        requestAnimationFrame(this.loop.bind(this));
    },

    initPlayer() {
        const u = Save.data.upgrades;

        // Calculate relic bonuses
        const relicBonus = this.getRelicBonus();

        this.player = {
            x: 0, y: 0, angle: 0, rotor: 0,
            hp: 100 + (u.start_hp*20), maxHp: 100 + (u.start_hp*20),
            level: 1, xp: 0, nextXp: 100, sp: 0, job: 1,
            jobId: null, // Current job (gunner, assault, etc)
            weapon: 'basic',
            xpMult: 1 + (u.xp_gain*0.15),
            relicBonus: relicBonus,
            stats: {
                dmg: 10 + (u.start_dmg*2),
                spd: 3 * (1 + (u.start_speed*0.1)),
                range: 1 + (u.start_range*0.15),
                def: 0,
                dmgMult: 1,
                crit: 5 + (u.start_crit*5),
                vamp: 0,
                regen: (u.start_regen*0.2) || 0,
                cdr: 0,
                chipMult: 1 + (u.chip_gain*0.1)
            },
            skills: { 1:false, 2:false, 3:false, 4:false },
            cd: { 1:0, 2:0, 3:0, 4:0 },
            active: { 2:0 },
            tree: {}, // Node progress
            kills: 0,
            combo: 0,
            comboTimer: 0,
            hitFlash: 0,
            shieldHitFlash: 0
        };
        // Reset Tree
        for(let t in TREES) TREES[t].forEach(n => this.player.tree[n.id] = 0);
    },

    loop() {
        if(this.state !== 'PLAY') return;
        this.update();
        this.render();
        requestAnimationFrame(this.loop.bind(this));
    },

    update() {
        const p = this.player;
        if(this.paused) return;
        if(p.hp <= 0) return this.gameOver();

        // Game Timer (60 FPS)
        this.gameTime++;

        // Spawn Final Boss at 15 minutes (54000 frames)
        if(this.gameTime >= 54000 && !this.finalBossSpawned) {
            this.spawnFinalBoss();
        }

        // Regen
        if(p.stats.regen > 0 && Math.random() < 0.01) p.hp = Math.min(p.maxHp, p.hp + p.stats.regen);

        // Combo Timer
        if(p.comboTimer > 0) {
            p.comboTimer--;
            if(p.comboTimer <= 0 && p.combo > 0) {
                p.combo = 0;
                document.getElementById('combo-display').style.display = 'none';
            }
        }

        // Hit Flash
        if(p.hitFlash > 0) p.hitFlash--;
        if(p.shieldHitFlash > 0) p.shieldHitFlash--;

        // 1. Controls
        let dx=0, dy=0;
        if(Input.keys['w']) dy--; if(Input.keys['s']) dy++;
        if(Input.keys['a']) dx--; if(Input.keys['d']) dx++;
        
        const spd = p.stats.spd * (p.active[2]>0 ? 0.7 : 1);
        if(dx||dy) {
            const len = Math.hypot(dx,dy);
            p.x += (dx/len)*spd;
            p.y += (dy/len)*spd;
        }

        // 2. Aim
        p.angle = Math.atan2(Input.mouse.y - (p.y - this.camera.y + canvas.height/2), Input.mouse.x - (p.x - this.camera.x + canvas.width/2));
        p.rotor += 0.5;

        // 3. Attack (Auto)
        if(Input.mouse.left && this.atkTimer <= 0) {
            const wpn = WEAPONS[p.weapon] || WEAPONS.basic;
            const rateMultiplier = (p.active[1] > 0 && p.jobId === 'berserker') ? 0.5 : 1;
            this.atkTimer = wpn.rate * rateMultiplier;
            this.fireWeapon(p, wpn);
        }
        if(this.atkTimer > 0) this.atkTimer--;

        // 4. Skills
        for(let k=1; k<=4; k++) if(p.cd[k] > 0) p.cd[k]--;

        // Active abilities tick
        if(p.active[1] > 0) p.active[1]--; // Berserker Rage / Guardian Shield

        // Shield Tick
        if(p.active[2] > 0) {
            p.active[2]--;
            if(p.active[2] % 10 === 0) this.fire(p.x, p.y, 0, 130, p.stats.dmg*0.5, 'aoe_silent');
        }

        // 5. Enemies
        if(this.enemies.length < 12 + p.level) this.spawnEnemy();
        
        this.enemies.forEach(e => {
            const dist = Math.hypot(p.x-e.x, p.y-e.y);
            const ang = Math.atan2(p.y-e.y, p.x-e.x);

            // AI
            if(e.type === 'shooter') {
                if(dist > 300) { e.x += Math.cos(ang)*e.speed; e.y += Math.sin(ang)*e.speed; }
                else if(dist < 200) { e.x -= Math.cos(ang)*e.speed; e.y -= Math.sin(ang)*e.speed; }

                if(e.cd <= 0) {
                    const diff = DIFFICULTIES[this.difficulty];
                    this.bullets.push({x:e.x, y:e.y, vx:Math.cos(ang)*5, vy:Math.sin(ang)*5, life:100, dmg:(5+p.level)*diff.dmgMult});
                    e.cd = 120;
                } else e.cd--;
            } else if (e.type === 'sniper') {
                // Stay far, shoot powerful shots
                if(dist > 500) { e.x += Math.cos(ang)*e.speed; e.y += Math.sin(ang)*e.speed; }
                else if(dist < 400) { e.x -= Math.cos(ang)*e.speed*1.5; e.y -= Math.sin(ang)*e.speed*1.5; }

                if(e.cd <= 0) {
                    const diff = DIFFICULTIES[this.difficulty];
                    this.bullets.push({x:e.x, y:e.y, vx:Math.cos(ang)*8, vy:Math.sin(ang)*8, life:150, dmg:(15+p.level*2)*diff.dmgMult});
                    e.cd = 180;
                } else e.cd--;
            } else if (e.type === 'tank') {
                // Slow but tanky, moves straight
                e.x += Math.cos(ang)*e.speed; e.y += Math.sin(ang)*e.speed;
            } else if (e.type === 'splitter') {
                // Normal movement, splits on death (handled in fire function)
                e.x += Math.cos(ang)*e.speed; e.y += Math.sin(ang)*e.speed;
            } else if (e.type === 'boss') {
                e.x += Math.cos(ang)*e.speed; e.y += Math.sin(ang)*e.speed;
                if(e.cd <= 0) {
                    const diff = DIFFICULTIES[this.difficulty];
                    for(let i=0; i<8; i++) {
                        let a = ang + (i * Math.PI/4);
                        this.bullets.push({x:e.x, y:e.y, vx:Math.cos(a)*4, vy:Math.sin(a)*4, life:100, dmg:(10+p.level)*diff.dmgMult});
                    }
                    e.cd = 90;
                } else e.cd--;
            } else if (e.type === 'finalboss') {
                // Final Boss AI
                e.x += Math.cos(ang)*e.speed; e.y += Math.sin(ang)*e.speed;

                if(e.cd <= 0) {
                    const diff = DIFFICULTIES[this.difficulty];

                    // Pattern changes by phase
                    if(e.hp < e.maxHp * 0.3) e.phase = 3;
                    else if(e.hp < e.maxHp * 0.7) e.phase = 2;

                    if(e.phase === 1) {
                        // Phase 1: 8-way spread
                        for(let i=0; i<8; i++) {
                            let a = ang + (i * Math.PI/4);
                            this.bullets.push({x:e.x, y:e.y, vx:Math.cos(a)*6, vy:Math.sin(a)*6, life:120, dmg:(15+p.level)*diff.dmgMult});
                        }
                        e.cd = 80;
                    } else if(e.phase === 2) {
                        // Phase 2: 16-way spiral
                        for(let i=0; i<16; i++) {
                            let a = ang + (i * Math.PI/8);
                            this.bullets.push({x:e.x, y:e.y, vx:Math.cos(a)*7, vy:Math.sin(a)*7, life:150, dmg:(20+p.level)*diff.dmgMult});
                        }
                        e.cd = 60;
                    } else {
                        // Phase 3: Random barrage
                        for(let i=0; i<24; i++) {
                            let a = Math.random() * Math.PI * 2;
                            this.bullets.push({x:e.x, y:e.y, vx:Math.cos(a)*8, vy:Math.sin(a)*8, life:180, dmg:(25+p.level)*diff.dmgMult});
                        }
                        e.cd = 40;
                    }
                } else e.cd--;
            } else { // Chaser (scout, dasher)
                e.x += Math.cos(ang)*e.speed; e.y += Math.sin(ang)*e.speed;
            }

            if(e.iframe > 0) e.iframe--;
            const contactDist = e.type==='finalboss'?80:e.type==='boss'?50:e.type==='tank'?25:20;
            if(dist < contactDist) {
                const dmgReduction = (p.active[1] > 0 && p.jobId === 'guardian') ? 0.2 : 1;
                const contactDmg = e.type==='finalboss'?2:e.type==='tank'?1:0.5;
                p.hp -= contactDmg * dmgReduction;
                p.hitFlash = 10;
            }
        });
        
        // Enemy Bullets
        this.bullets.forEach(b => {
            b.x += b.vx; b.y += b.vy; b.life--;
            if(Math.hypot(b.x-p.x, b.y-p.y) < 15) {
                // Plasma Shield blocks all damage
                if(p.active[2] > 0) {
                    b.life = 0;
                    p.shieldHitFlash = 8;
                    this.particles.push({x:b.x, y:b.y, type:'spark', life:15, c:'#0ff'});
                } else {
                    const dmgReduction = (p.active[1] > 0 && p.jobId === 'guardian') ? 0.2 : 1;
                    p.hp -= b.dmg * dmgReduction; b.life = 0;
                    p.hitFlash = 10;
                }
            }
        });
        this.enemies = this.enemies.filter(e => e.hp > 0);
        this.bullets = this.bullets.filter(b => b.life > 0);

        // 6. Camera
        this.camera.x += (p.x - this.camera.x) * 0.1;
        this.camera.y += (p.y - this.camera.y) * 0.1;
        if(this.camera.shake > 0) {
            this.camera.x += (Math.random()-0.5)*this.camera.shake;
            this.camera.y += (Math.random()-0.5)*this.camera.shake;
            this.camera.shake *= 0.9;
        }

        // Cleanup & Missile Homing
        this.particles.forEach(pt => {
            if(pt.type === 'missile' && pt.life > 0) {
                // Find closest enemy
                let closest = null, minDist = 999999;
                this.enemies.forEach(e => {
                    const d = Math.hypot(e.x - pt.x, e.y - pt.y);
                    if(d < minDist && d < pt.range) { minDist = d; closest = e; }
                });

                if(closest) {
                    const targetAngle = Math.atan2(closest.y - pt.y, closest.x - pt.x);
                    pt.angle += Math.sign(targetAngle - pt.angle) * 0.1;
                }

                pt.x += pt.vx; pt.y += pt.vy;
                pt.vx = Math.cos(pt.angle) * 8; pt.vy = Math.sin(pt.angle) * 8;

                // Check collision with enemies
                this.enemies.forEach(e => {
                    if(Math.hypot(e.x - pt.x, e.y - pt.y) < 20 && e.iframe <= 0) {
                        let d = pt.dmg;
                        if(Math.random()*100 < pt.crit) { d *= 2; this.spawnText(e.x, e.y, "CRIT!", "#ff0"); }
                        e.hp -= d; e.iframe = 5;
                        this.spawnText(e.x, e.y, Math.floor(d), "#fff");
                        pt.life = 0;

                        if(e.hp <= 0) {
                            this.player.kills++;
                            this.player.combo++;
                            this.player.comboTimer = 180;

                            const comboDisplay = document.getElementById('combo-display');
                            comboDisplay.style.display = 'block';
                            document.getElementById('combo-number').innerText = this.player.combo;
                            const mult = 1 + Math.floor(this.player.combo / 5) * 0.2;
                            document.getElementById('combo-mult').innerText = `x${mult.toFixed(1)} CHIPS`;
                            if(this.player.combo % 10 === 0 && this.player.combo > 0) {
                                this.showToast(`${this.player.combo} COMBO!`);
                            }
                            this.gainXp(e.type==='boss'?500:50);
                        }
                    }
                });
            }
            pt.life--;
        });
        this.particles = this.particles.filter(pt => pt.life > 0);
        this.texts.forEach(t => { t.y--; t.life--; });
        this.texts = this.texts.filter(t => t.life > 0);

        UI.update();
    },

    fireWeapon(p, wpn) {
        const baseDmg = p.stats.dmg * p.stats.dmgMult * wpn.dmg;
        const baseRange = wpn.range * p.stats.range;
        const critChance = p.stats.crit + (wpn.critBonus || 0);

        for(let i = 0; i < wpn.bullets; i++) {
            const spreadAngle = p.angle + (Math.random() - 0.5) * wpn.spread;

            if(wpn.homing) {
                // Missile - homing projectile
                this.particles.push({
                    x: p.x, y: p.y, angle: spreadAngle, vx: Math.cos(spreadAngle) * 8,
                    vy: Math.sin(spreadAngle) * 8, range: baseRange, dmg: baseDmg,
                    type: 'missile', life: 100, c: '#f80', crit: critChance
                });
            } else if(wpn.aoe) {
                // AOE weapon (cannon, rocket)
                const hitX = p.x + Math.cos(spreadAngle) * baseRange;
                const hitY = p.y + Math.sin(spreadAngle) * baseRange;
                this.fire(hitX, hitY, 0, wpn.aoe, baseDmg, 'aoe');
                this.particles.push({x: p.x, y: p.y, angle: spreadAngle, range: baseRange, type: 'beam', life: 8, c: '#f40'});
            } else if(wpn.pierce) {
                // Piercing weapon
                this.fire(p.x, p.y, spreadAngle, baseRange, baseDmg, 'pierce');
                this.particles.push({x: p.x, y: p.y, angle: spreadAngle, range: baseRange, type: 'beam', life: 10, c: '#0ff'});
            } else {
                // Normal shot
                this.fire(p.x, p.y, spreadAngle, baseRange, baseDmg, 'shot');
                this.particles.push({x: p.x, y: p.y, angle: spreadAngle, range: baseRange, type: 'beam', life: 5, c: '#0ff'});
            }
        }
    },

    fire(x, y, angle, range, dmg, type) {
        if(type==='shot') this.particles.push({x,y,angle,range,type:'beam',life:5,c:'#0ff'});
        if(type.includes('aoe')) this.particles.push({x,y,range,type:'nova',life:10,c:'#08f'});

        this.enemies.forEach(e => {
            const dx = e.x - x, dy = e.y - y;
            const dist = Math.hypot(dx, dy);
            let hit = false;

            if(type === 'shot') {
                const angTo = Math.atan2(dy, dx);
                if(dist < range && Math.abs(angTo - angle) < 0.3) hit = true;
            } else if (type.includes('aoe') || type === 'nuke') {
                if(dist < range) hit = true;
            }

            if(hit && e.iframe <= 0) {
                let d = dmg;
                if(Math.random()*100 < this.player.stats.crit) { d *= 2; this.spawnText(e.x, e.y, "CRIT!", "#ff0"); }
                
                e.hp -= d; e.iframe = 5;
                e.x += Math.cos(angle)*10; e.y += Math.sin(angle)*10;
                
                if(type !== 'aoe_silent') this.spawnText(e.x, e.y, Math.floor(d), "#fff");
                if(this.player.stats.vamp > 0) this.player.hp = Math.min(this.player.maxHp, this.player.hp + this.player.stats.vamp);

                if(e.hp <= 0) {
                    // Final Boss cleared!
                    if(e.type === 'finalboss') {
                        this.clearStage();
                        return;
                    }

                    this.player.kills++;
                    this.player.combo++;
                    this.player.comboTimer = 180; // 3 seconds at 60fps

                    // Splitter: spawn 3 mini enemies
                    if(e.type === 'splitter' && !e.isMini) {
                        for(let i=0; i<3; i++) {
                            const ang = (i * Math.PI * 2 / 3);
                            this.enemies.push({
                                x: e.x + Math.cos(ang)*30,
                                y: e.y + Math.sin(ang)*30,
                                type: 'splitter',
                                hp: e.maxHp * 0.3,
                                maxHp: e.maxHp * 0.3,
                                speed: e.speed * 1.5,
                                iframe: 10,
                                cd: 60,
                                isMini: true
                            });
                        }
                    }

                    // Show combo display
                    const comboDisplay = document.getElementById('combo-display');
                    comboDisplay.style.display = 'block';
                    document.getElementById('combo-number').innerText = this.player.combo;

                    // Calculate multiplier
                    const mult = 1 + Math.floor(this.player.combo / 5) * 0.2;
                    document.getElementById('combo-mult').innerText = `x${mult.toFixed(1)} CHIPS`;

                    // Show milestone toasts
                    if(this.player.combo % 10 === 0 && this.player.combo > 0) {
                        this.showToast(`${this.player.combo} COMBO!`);
                    }

                    this.gainXp(e.type==='boss'?500:50);
                }
            }
        });
    },

    getRelicBonus() {
        const bonus = { dmg: 1, hp: 1, crit: 1, spd: 1, range: 1, cdr: 1 };
        const relics = Save.data.relics;

        for(let key in relics) {
            const [stat, rarity] = key.split('_');
            const rarityData = RARITY[rarity];
            const relicType = RELIC_TYPES.find(r => r.id === stat);
            if(relicType && rarityData) {
                const value = relicType.value * rarityData.mult * relics[key];
                bonus[stat] *= (1 + value);
            }
        }
        return bonus;
    },

    spawnEnemy() {
        const p = this.player;
        const diff = DIFFICULTIES[this.difficulty];
        const ang = Math.random()*6.28, dist = 700;
        const x = p.x + Math.cos(ang)*dist, y = p.y + Math.sin(ang)*dist;

        // Time-based enemy spawning (60 FPS)
        const minutes = this.gameTime / 3600;

        let type='scout', hp=(20+p.level*10) * diff.hpMult, spd=1.5+Math.random();

        // Boss every 10 levels
        if(p.level % 10 === 0 && p.level > 0 && !this.enemies.find(e=>e.type==='boss')) {
            type='boss'; hp*=15; spd=0.5;
            this.spawnText(p.x, p.y-100, "âš ï¸ WARNING âš ï¸", "#f04");
        }
        else {
            const rand = Math.random();

            // Time-based progression
            if(minutes >= 12 && rand < 0.15) { type='sniper'; hp*=0.7; spd=0.8; } // 12min+
            else if(minutes >= 10 && rand < 0.25) { type='tank'; hp*=2.5; spd=0.4; } // 10min+
            else if(minutes >= 7 && rand < 0.35) { type='splitter'; hp*=1.1; spd=1.2; } // 7min+
            else if(minutes >= 5 && rand < 0.55) { type='dasher'; hp*=1.2; spd=2; } // 5min+
            else if(minutes >= 3 && rand < 0.70) { type='shooter'; hp*=0.8; spd=1; } // 3min+
        }

        this.enemies.push({ x, y, type, hp, maxHp:hp, speed:spd, iframe:0, cd:60 });
    },

    gainXp(amt) {
        const p = this.player;
        p.xp += Math.floor(amt * p.xpMult);
        if(p.xp >= p.nextXp) {
            p.level++; p.xp = 0; p.nextXp *= 1.1; p.sp += 3; p.hp = p.maxHp;

            // Level scaling stats
            p.stats.dmg += 0.1 * p.relicBonus.dmg;
            p.maxHp += 1 * p.relicBonus.hp;
            p.hp = p.maxHp;

            this.spawnText(p.x, p.y-50, "SYSTEM UPGRADE", "#0f0");
            this.showToast("SYSTEM UPGRADE");

            // Track highest level
            if(!Save.data.highestLevel[this.difficulty] || p.level > Save.data.highestLevel[this.difficulty]) {
                Save.data.highestLevel[this.difficulty] = p.level;
            }

            // Job Advancement
            if(p.level === 10 && !p.jobId) {
                // 1st Job - Basic weapon, skill + passive
                this.paused = true;
                UI.showJobSelect(['tactician', 'berserker', 'guardian']);
            }
            if(p.level === 30 && p.jobId && JOBS[p.jobId].unlockLv === 10) {
                // 2nd Job - Weapon choice
                this.paused = true;
                UI.showJobSelect(['gunner', 'lancer', 'marksman']);
            }
            if(p.level === 60 && p.jobId && JOBS[p.jobId].unlockLv === 30) {
                // 3rd Job - Specialization
                this.paused = true;
                const options = Object.keys(JOBS).filter(j => JOBS[j].parent === p.jobId);
                UI.showJobSelect(options);
            }
            if(p.level === 100 && p.jobId && JOBS[p.jobId].unlockLv === 60) {
                // 4th Job - Ultimate
                this.paused = true;
                const options = Object.keys(JOBS).filter(j => JOBS[j].parent === p.jobId);
                UI.showJobSelect(options);
            }

            if(p.level===5) p.job=2;
            if(p.level===15) p.job=3;
            if(p.level===30) p.job=4;
            UI.refreshTabs();
        }
    },

    useSkill(tier) {
        const p = this.player;
        if(p.cd[tier] > 0 || !p.skills[tier]) return;

        const cdr = 1 - p.stats.cdr;
        const dmg = p.stats.dmg * p.stats.dmgMult;

        // 1st Job Skills
        if(tier === 1 && p.jobSkill) {
            const skill = p.jobSkill;
            p.cd[1] = skill.cd * cdr;

            if(p.jobId === 'tactician') {
                // Tactical Strike - 3-round burst
                for(let i=0; i<3; i++) {
                    setTimeout(() => {
                        this.fire(p.x, p.y, p.angle, 500, dmg * 2, 'shot');
                        this.particles.push({x:p.x, y:p.y, angle:p.angle, range:500, type:'beam', life:8, c:'#0ff'});
                    }, i * 100);
                }
            } else if(p.jobId === 'berserker') {
                // Rage Mode - double fire rate
                p.active[1] = skill.duration;
                this.showToast("RAGE MODE!");
            } else if(p.jobId === 'guardian') {
                // Shield Dome - protect + heal
                p.active[1] = skill.duration;
                p.hp = Math.min(p.maxHp, p.hp + 30);
                this.showToast("SHIELD DOME!");
            }
        } else if(tier === 1 && !p.jobSkill) {
            // Default Railgun
            this.fire(p.x, p.y, p.angle, 600, dmg * 5, 'shot');
            p.cd[1] = 120 * cdr;
            this.particles.push({x:p.x, y:p.y, angle:p.angle, range:600, type:'beam', life:15, c:'#f0f'});
        } else if(tier === 2) { // Shield
            p.active[2] = 300; p.cd[2] = 600 * cdr;
        } else if(tier === 3) { // EMP
            this.fire(p.x, p.y, 0, 300, dmg*2, 'aoe');
            this.enemies.forEach(e => { if(Math.hypot(e.x-p.x, e.y-p.y) < 300) e.speed = 0; });
            p.cd[3] = 600 * cdr; this.camera.shake = 20;
        } else if(tier === 4) { // Nuke
            this.fire(p.x, p.y, 0, 9999, 9999, 'nuke');
            this.camera.shake = 50; p.cd[4] = 1800 * cdr;
        }
    },

    gameOver() {
        this.state = 'GAMEOVER';
        const comboMult = 1 + Math.floor(this.player.combo / 5) * 0.2;
        const earned = Math.floor(this.player.kills * this.player.stats.chipMult * comboMult);
        Save.data.souls += earned;
        Save.save();
        
        document.getElementById('hud-layer').classList.add('hidden');
        document.getElementById('game-over').classList.remove('hidden');
        document.getElementById('end-lv').innerText = this.player.level;
        document.getElementById('end-kills').innerText = this.player.kills;
        document.getElementById('end-souls').innerText = earned;
    },

    toMenu() {
        location.reload();
    },

    spawnFinalBoss() {
        this.finalBossSpawned = true;
        const p = this.player;
        const diff = DIFFICULTIES[this.difficulty];

        // Calculate boss HP based on level 200 stats (~30 damage * 250 hits = 7500)
        // NORMAL: 7500, HARD: 15000, VERY HARD: 37500, INFERNO: 75000
        const bossHp = 7500 * diff.hpMult;

        this.enemies.push({
            x: p.x,
            y: p.y - 500,
            type: 'finalboss',
            hp: bossHp,
            maxHp: bossHp,
            speed: 1,
            iframe: 0,
            cd: 60,
            phase: 1
        });

        this.spawnText(p.x, p.y-100, "âš ï¸ FINAL BOSS âš ï¸", "#f04");
        this.showToast("FINAL BOSS APPROACHING!");
        this.camera.shake = 30;
    },

    clearStage() {
        Save.data.cleared[this.difficulty] = true;
        this.unlockNextDifficulty();
        Save.save();
        this.showToast(`${DIFFICULTIES[this.difficulty].name} CLEARED!`);
        setTimeout(() => this.gameOver(), 2000);
    },

    unlockNextDifficulty() {
        const order = ['normal', 'hard', 'veryhard', 'inferno'];
        const idx = order.indexOf(this.difficulty);
        if(idx >= 0 && idx < order.length - 1) {
            DIFFICULTIES[order[idx + 1]].unlock = true;
        }
    },

    spawnText(x,y,t,c) { this.texts.push({x,y,t,c,life:40}); },
    showToast(msg) {
        const t = document.createElement('div'); t.className='toast'; t.innerText=msg;
        document.body.appendChild(t); setTimeout(()=>t.remove(), 2000);
    },

    render() {
        ctx.fillStyle = "#0b0d10"; ctx.fillRect(0,0,canvas.width, canvas.height);

        // Hit flash effect
        if(this.player.hitFlash > 0) {
            ctx.fillStyle = `rgba(255, 0, 0, ${this.player.hitFlash / 30})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        ctx.save(); ctx.translate(-this.camera.x + canvas.width/2, -this.camera.y + canvas.height/2);

        // Grid
        ctx.strokeStyle = "#1a2530"; ctx.lineWidth=2;
        const g=100, cx=Math.floor(this.camera.x/g)*g, cy=Math.floor(this.camera.y/g)*g;
        ctx.beginPath();
        for(let i=-12; i<12; i++) {
            ctx.moveTo(cx+i*g, cy-1200); ctx.lineTo(cx+i*g, cy+1200);
            ctx.moveTo(cx-1200, cy+i*g); ctx.lineTo(cx+1200, cy+i*g);
        }
        ctx.stroke();

        // Enemies
        this.enemies.forEach(e => {
            ctx.save(); ctx.translate(e.x, e.y);
            let p = GFX[e.type] || GFX.scout;
            let s = e.isMini ? 0.8 : (e.type==='finalboss'?6:e.type==='boss'?4:e.type==='tank'?2:1.5);
            let c = '#a35'; // default

            if(e.type==='finalboss') {
                // Final boss color changes by phase
                if(e.phase === 3) c='#f00';
                else if(e.phase === 2) c='#f80';
                else c='#f04';
            }
            else if(e.type==='boss') c='#f04';
            else if(e.type==='shooter') c='#a0f';
            else if(e.type==='sniper') c='#f80';
            else if(e.type==='tank') c='#666';
            else if(e.type==='splitter') c='#0af';
            else if(e.type==='dasher') c='#f0f';

            if(e.iframe>0) c='#fff';

            ctx.fillStyle = c; ctx.scale(s, s); ctx.fill(p);

            // HP Bar
            if(e.type==='finalboss') {
                // Large HP bar for final boss
                ctx.fillStyle="rgba(0,0,0,0.7)"; ctx.fillRect(-80, -70, 160, 10);
                ctx.fillStyle="#0f0"; ctx.fillRect(-80, -70, 160*(e.hp/e.maxHp), 10);
                ctx.fillStyle="#fff"; ctx.font="12px Arial"; ctx.fillText(`FINAL BOSS`, -40, -75);
            } else {
                ctx.fillStyle="#f04"; ctx.fillRect(-15, -20, 30*(e.hp/e.maxHp), 3);
            }
            ctx.restore();
        });

        // Enemy Bullets (larger and more visible)
        this.bullets.forEach(b => {
            ctx.save();
            ctx.translate(b.x, b.y);
            ctx.fillStyle="#ff0044";
            ctx.shadowBlur = 10;
            ctx.shadowColor = "#ff0044";
            ctx.beginPath();
            ctx.arc(0, 0, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.restore();
        });

        // Player
        const p = this.player;
        ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.angle);

        // Hit flash on player
        if(p.hitFlash > 0 && p.hitFlash % 4 < 2) {
            ctx.fillStyle="#fff"; ctx.strokeStyle="#fff";
        } else {
            ctx.fillStyle="#000"; ctx.strokeStyle="#00aaff";
        }
        ctx.lineWidth=2;
        ctx.fill(GFX.drone); ctx.stroke(GFX.drone);
        
        ctx.strokeStyle="#445566"; ctx.stroke(GFX.arm);
        
        const rA = p.rotor;
        [ [25,25], [-25,25], [25,-25], [-25,-25] ].forEach(([rx,ry], i) => {
            ctx.save(); ctx.translate(rx, ry); 
            ctx.rotate(i%2==0 ? rA : -rA); 
            ctx.strokeStyle="#00ffff"; ctx.stroke(GFX.blade); 
            ctx.restore();
        });
        
        // Active effects visualization
        if(p.active[2]>0) {
            const shieldAlpha = p.shieldHitFlash > 0 ? 0.8 : 0.4;
            const shieldRadius = p.shieldHitFlash > 0 ? 65 : 60;
            ctx.strokeStyle=`rgba(0,255,255,${shieldAlpha})`;
            ctx.lineWidth = p.shieldHitFlash > 0 ? 4 : 2;
            ctx.beginPath(); ctx.arc(0,0,shieldRadius,0,6.28); ctx.stroke();
            if(p.shieldHitFlash > 0) {
                ctx.strokeStyle="rgba(255,255,255,0.6)";
                ctx.beginPath(); ctx.arc(0,0,shieldRadius+5,0,6.28); ctx.stroke();
            }
        }
        if(p.active[1]>0 && p.jobId==='guardian') {
            ctx.strokeStyle="rgba(100,255,100,0.5)"; ctx.lineWidth=3;
            ctx.beginPath(); ctx.arc(0,0,50,0,6.28); ctx.stroke();
        }
        if(p.active[1]>0 && p.jobId==='berserker') {
            ctx.strokeStyle="rgba(255,50,50,0.6)"; ctx.lineWidth=2;
            ctx.beginPath(); ctx.arc(0,0,40,0,6.28); ctx.stroke();
        }
        ctx.restore();

        // Particles
        this.particles.forEach(pt => {
            if(pt.type==='beam') {
                ctx.strokeStyle=pt.c; ctx.lineWidth=4; ctx.save(); ctx.translate(pt.x,pt.y); ctx.rotate(pt.angle);
                ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(pt.range,0); ctx.stroke(); ctx.restore();
            } else if(pt.type==='nova') {
                ctx.fillStyle="rgba(0,200,255,0.2)"; ctx.beginPath(); ctx.arc(pt.x,pt.y,pt.range,0,6.28); ctx.fill();
            } else if(pt.type==='missile') {
                ctx.save(); ctx.translate(pt.x, pt.y); ctx.rotate(pt.angle);
                ctx.fillStyle=pt.c; ctx.fillRect(-8, -3, 16, 6);
                ctx.fillStyle='#fff'; ctx.fillRect(4, -2, 4, 4);
                ctx.restore();
            } else { ctx.fillStyle=pt.c; ctx.fillRect(pt.x,pt.y,3,3); }
        });

        // Text
        this.texts.forEach(t => { ctx.fillStyle=t.c; ctx.font="bold 16px Arial"; ctx.fillText(t.t, t.x, t.y); });
        
        ctx.restore();
    }
};

const UI = {
    activeTab: 1,
    openRelicGacha() {
        document.getElementById('relic-gacha').classList.remove('hidden');
        document.getElementById('gacha-result').innerHTML = '<div style="color: #aaa;">Select roll count to begin</div>';
        this.updateRelicInventory();
    },
    closeRelicGacha() {
        document.getElementById('relic-gacha').classList.add('hidden');
    },
    rollRelic(count) {
        const cost = 100 * count;
        if(Save.data.souls < cost) {
            document.getElementById('gacha-result').innerHTML = '<div style="color: #f44;">Not enough Data Chips!</div>';
            return;
        }

        Save.data.souls -= cost;
        document.getElementById('menu-souls').innerText = Save.data.souls;

        const results = [];
        for(let i=0; i<count; i++) {
            const relic = this.getRandomRelic();
            results.push(relic);

            const key = `${relic.type}_${relic.rarity}`;
            if(!Save.data.relics[key]) Save.data.relics[key] = 0;
            Save.data.relics[key]++;
        }

        Save.save();

        // Display results
        const resultDiv = document.getElementById('gacha-result');
        resultDiv.innerHTML = '<div style="font-size: 20px; color: #00ffff; margin-bottom: 15px;">RESULTS</div>';

        const grid = document.createElement('div');
        grid.style.cssText = 'display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;';

        results.forEach(r => {
            const card = document.createElement('div');
            card.style.cssText = `padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid ${RARITY[r.rarity].color}; border-radius: 6px; text-align: center;`;
            card.innerHTML = `
                <div style="font-size: 10px; color: ${RARITY[r.rarity].color};">${RARITY[r.rarity].name}</div>
                <div style="font-size: 11px; color: #fff; margin-top: 3px;">${RELIC_TYPES.find(t=>t.id===r.type).name}</div>
            `;
            grid.appendChild(card);
        });

        resultDiv.appendChild(grid);
        this.updateRelicInventory();
    },
    getRandomRelic() {
        // Roll rarity
        const rand = Math.random();
        let rarity = 'common';
        let cumulative = 0;
        for(let r in RARITY) {
            cumulative += RARITY[r].chance;
            if(rand < cumulative) { rarity = r; break; }
        }

        // Roll type
        const type = RELIC_TYPES[Math.floor(Math.random() * RELIC_TYPES.length)].id;

        return { type, rarity };
    },
    updateRelicInventory() {
        const inv = document.getElementById('relic-inventory');
        inv.innerHTML = '';

        const relics = Save.data.relics;
        if(Object.keys(relics).length === 0) {
            inv.innerHTML = '<div style="color: #555;">No relics yet</div>';
            return;
        }

        for(let key in relics) {
            if(relics[key] > 0) {
                const [stat, rarity] = key.split('_');
                const relicType = RELIC_TYPES.find(r => r.id === stat);
                const rarityData = RARITY[rarity];

                const div = document.createElement('div');
                div.style.cssText = 'padding: 5px; margin-bottom: 3px; background: rgba(0,0,0,0.3); border-left: 3px solid ' + rarityData.color;
                div.innerHTML = `<span style="color: ${rarityData.color}">${rarityData.name}</span> ${relicType.name} x${relics[key]}`;
                inv.appendChild(div);
            }
        }
    },
    showJobSelect(jobIds) {
        const container = document.getElementById('job-options');
        container.innerHTML = '';

        jobIds.forEach(jid => {
            const job = JOBS[jid];
            const card = document.createElement('div');
            card.className = 'glass-panel';
            card.style.cssText = 'width: 200px; padding: 30px; text-align: center; cursor: pointer; transition: 0.3s;';
            card.innerHTML = `
                <div style="font-size: 64px; margin-bottom: 15px;">${job.icon}</div>
                <h3 style="font-size: 24px; color: #00ffff; margin: 10px 0;">${job.name}</h3>
                <p style="font-size: 14px; color: #aaa; margin: 10px 0;">${job.desc}</p>
                <div style="font-size: 12px; color: #579; margin-top: 15px;">WEAPON: ${WEAPONS[job.weapon] ? job.weapon.toUpperCase() : 'BASIC'}</div>
            `;
            card.onmouseover = () => card.style.transform = 'translateY(-10px)';
            card.onmouseout = () => card.style.transform = 'translateY(0)';
            card.onclick = () => this.selectJob(jid);
            container.appendChild(card);
        });

        document.getElementById('job-select').classList.remove('hidden');
    },
    selectJob(jobId) {
        const job = JOBS[jobId];
        const p = Game.player;

        // Store previous job for parent tracking
        p.prevJobId = p.jobId;
        p.jobId = jobId;
        p.weapon = job.weapon;

        // Apply 1st job passives
        if(job.unlockLv === 10 && job.passive) {
            if(job.passive.hp) { p.maxHp += job.passive.hp; p.hp += job.passive.hp; }
            if(job.passive.dmg) p.stats.dmg += job.passive.dmg;
            if(job.passive.dmgMult) p.stats.dmgMult += job.passive.dmgMult;
            if(job.passive.cdr) p.stats.cdr += job.passive.cdr;
            if(job.passive.regen) p.stats.regen += job.passive.regen;
        }

        // Activate 1st job skill
        if(job.skill) {
            p.skills[job.skill.tier] = true;
            p.jobSkill = job.skill;
            document.getElementById('icon-'+job.skill.tier).innerText = 'âœ¨';
        }

        Game.showToast(`JOB: ${job.name.toUpperCase()}`);
        document.getElementById('job-select').classList.add('hidden');
        document.getElementById('hud-job').innerText = job.name.toUpperCase();
        Game.paused = false;
    },
    update() {
        const p = Game.player;
        document.getElementById('hud-lv').innerText = p.level;
        const hpPercent = Math.max(0, (p.hp/p.maxHp)*100);
        document.getElementById('hud-hp').style.height = hpPercent + "%";
        document.getElementById('hud-hp-text').innerText = Math.floor(hpPercent) + "%";
        document.getElementById('hud-xp').style.width = (p.xp/p.nextXp)*100 + "%";

        // Timer
        const remaining = Math.max(0, 54000 - Game.gameTime);
        const mins = Math.floor(remaining / 3600);
        const secs = Math.floor((remaining % 3600) / 60);
        document.getElementById('hud-timer').innerText = `${mins}:${secs.toString().padStart(2, '0')}`;

        for(let i=1; i<=4; i++) {
            const el = document.getElementById('cd-'+i);
            el.innerText = p.cd[i] > 0 ? Math.ceil(p.cd[i]/60) : "";
        }
    },
    refreshTabs() {
        const p = Game.player;
        for(let i=1; i<=4; i++) {
            const tab = document.getElementById('tab-'+i);
            if(p.job >= i) tab.classList.remove('locked');
            if(p.skills[i]) document.getElementById('icon-'+i).innerText = TREES[i].find(n=>n.type==='active').icon;
        }
    },
    toggleTree() {
        const w = document.getElementById('skill-window');
        w.classList.toggle('hidden');
        Game.paused = !w.classList.contains('hidden');
        document.getElementById('paused-indicator').style.display = Game.paused ? 'block' : 'none';
        if(!w.classList.contains('hidden')) this.renderTree();
    },
    switchTab(t) {
        this.activeTab = t;
        for(let i=1; i<=4; i++) {
            const tab = document.getElementById('tab-'+i);
            if(i === t) tab.classList.add('active'); else tab.classList.remove('active');
        }
        this.renderTree();
    },
    renderTree() {
        const nodes = document.getElementById('tree-nodes');
        const lines = document.getElementById('tree-lines');
        nodes.innerHTML=''; lines.innerHTML='';
        document.getElementById('tree-sp').innerText = Game.player.sp;
        
        const data = TREES[this.activeTab];
        
        data.forEach(n => {
            if(n.parent) {
                const p = data.find(x => x.id === n.parent);
                const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
                l.setAttribute("x1",p.x); l.setAttribute("y1",p.y); l.setAttribute("x2",n.x); l.setAttribute("y2",n.y);
                l.setAttribute("stroke", Game.player.tree[n.id]>0?"#00ffff":"#004488"); l.setAttribute("stroke-width", 2);
                lines.appendChild(l);
            }
        });

        data.forEach(n => {
            const div = document.createElement('div');
            const cur = Game.player.tree[n.id];
            div.className = `node ${cur>=n.max?'maxed':''} ${n.type==='active'?'skill-unlock':''}`;
            
            let locked = true;
            if(!n.parent) locked = false;
            else if(Game.player.tree[n.parent] > 0) locked = false;
            
            if(locked) div.classList.add('locked');
            div.style.left=n.x+'px'; div.style.top=n.y+'px';
            div.innerHTML = `<div>${n.type==='active'?n.icon:cur}</div>
                <div class="tooltip"><strong class="text-cyan">${n.name}</strong><br>${n.desc}<br>Lv: ${cur}/${n.max}</div>`;
            
            div.onclick = () => {
                if(!locked && Game.player.sp > 0 && cur < n.max) {
                    Game.player.sp--; Game.player.tree[n.id]++;
                    if(n.type==='active') { Game.player.skills[n.tier]=true; UI.refreshTabs(); }
                    else if(n.type==='passive') {
                        if(n.stat==='all') { for(let k in Game.player.stats) Game.player.stats[k]+=n.val; }
                        else Game.player.stats[n.stat]+=n.val;
                        if(n.stat==='hp') Game.player.maxHp+=n.val;
                    }
                    UI.renderTree();
                }
            };
            nodes.appendChild(div);
        });
    }
};

const Input = { keys: {}, mouse: {x:0, y:0, left:false} };
window.onkeydown = e => {
    Input.keys[e.key.toLowerCase()] = true;
    if(e.key.toLowerCase() === 'k') UI.toggleTree();
    if(e.code === 'Space') Game.useSkill(2);
    if(e.key.toLowerCase() === 'r') Game.useSkill(3);
    if(e.key.toLowerCase() === 'f') Game.useSkill(4);
};
window.onkeyup = e => Input.keys[e.key.toLowerCase()] = false;
window.onmousedown = e => { if(e.button===0) Input.mouse.left=true; if(e.button===2) Game.useSkill(1); };
window.onmouseup = e => { if(e.button===0) Input.mouse.left=false; };
window.onmousemove = e => { Input.mouse.x=e.clientX; Input.mouse.y=e.clientY; };

// MENU INIT
Save.load();
document.getElementById('menu-souls').innerText = Save.data.souls;

// Unlock difficulties based on clears
if(Save.data.cleared.normal) DIFFICULTIES.hard.unlock = true;
if(Save.data.cleared.hard) DIFFICULTIES.veryhard.unlock = true;
if(Save.data.cleared.veryhard) DIFFICULTIES.inferno.unlock = true;

// Show relic gacha if normal cleared
if(Save.data.cleared.normal) {
    document.getElementById('relic-btn').style.display = 'block';
}

// Difficulty Select
const diffSelect = document.getElementById('difficulty-select');
for(let key in DIFFICULTIES) {
    const diff = DIFFICULTIES[key];
    const btn = document.createElement('div');
    btn.className = 'glass-panel';
    btn.style.cssText = `padding: 15px 30px; cursor: pointer; transition: 0.3s; opacity: ${diff.unlock?1:0.3}; pointer-events: ${diff.unlock?'auto':'none'}; border: 2px solid ${diff.chipColor};`;
    btn.innerHTML = `<div style="font-size: 16px; font-weight: bold; color: ${diff.chipColor};">${diff.name}</div>` +
        (Save.data.cleared[key] ? '<div style="font-size: 10px; color: #0f0; margin-top: 5px;">âœ“ CLEARED</div>' : '') +
        (Save.data.highestLevel[key] ? `<div style="font-size: 10px; color: #aaa; margin-top: 3px;">Best: Lv${Save.data.highestLevel[key]}</div>` : '');

    btn.onclick = () => {
        Game.difficulty = key;
        document.querySelectorAll('#difficulty-select > div').forEach(d => d.style.background = 'rgba(20, 30, 40, 0.7)');
        btn.style.background = 'rgba(0, 100, 200, 0.5)';
    };

    if(key === 'normal') {
        btn.style.background = 'rgba(0, 100, 200, 0.5)';
    }

    diffSelect.appendChild(btn);
}

// Shop
const sl = document.getElementById('shop-list');
SHOP_DATA.forEach(i => {
    const d = document.createElement('div'); d.className='shop-card glass-panel';
    const lv = Save.data.upgrades[i.id];
    d.innerHTML = `<h3>${i.name}</h3><p>${i.desc}</p><div class="cost">ðŸ’¾ ${i.cost}</div><div class="lvl">LV. ${lv}/${i.max}</div>`;
    d.onclick = () => { if(Save.data.souls >= i.cost && lv < i.max) { Save.data.souls-=i.cost; Save.data.upgrades[i.id]++; Save.save(); location.reload(); }};
    sl.appendChild(d);
});
</script>
</body>
</html>