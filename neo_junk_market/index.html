<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„¤ì˜¨ ì •í¬ ë§ˆì¼“: ì˜¤ë²„í´ëŸ­ (í•˜ë“œ ëª¨ë“œ, ìµœì¢…)</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --text-main: #c9d1d9;
            --accent-screw: #ff4757; /* ë‚˜ì‚¬ (Red) */
            --accent-wire: #2ed573;  /* ì „ì„  (Green) */
            --accent-alloy: #1e90ff; /* í•©ê¸ˆ (Blue) */
            --accent-battery: #ffffff; /* ë°°í„°ë¦¬ (White) */
            --accent-core: #ffa502;  /* ì½”ì–´ (Gold) */
            --neon-border: 0 0 5px rgba(255, 255, 255, 0.3);
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            user-select: none;
            overflow-x: hidden;
        }

        /* ë ˆì´ì•„ì›ƒ */
        .game-container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        header {
            text-align: center;
            border-bottom: 2px solid #30363d;
            padding-bottom: 10px;
        }
        
        h1 { margin: 0; font-size: 1.5rem; color: var(--accent-core); text-shadow: 0 0 10px var(--accent-core); }
        .sub-text { font-size: 0.8rem; color: #8b949e; }

        /* ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .area {
            background: #21262d;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #30363d;
        }
        
        .area-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        /* ìì› í‘œì‹œ */
        .resource-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .res-badge {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: bold;
            color: #000;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .res-screw { background: var(--accent-screw); }
        .res-wire { background: var(--accent-wire); }
        .res-alloy { background: var(--accent-alloy); }
        .res-battery { background: var(--accent-battery); color: #000;}
        .res-core { background: var(--accent-core); box-shadow: 0 0 8px var(--accent-core); color: #000;}

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }
        .card {
            background: var(--card-bg);
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            position: relative;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 10px rgba(255,255,255,0.1);
        }
        .card.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(1);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
        }
        .card-vp { color: #eebb00; }
        .card-bonus { font-size: 0.8rem; padding: 2px 5px; border-radius: 3px; color: #000; }
        
        .cost-list {
            display: flex;
            gap: 4px;
            font-size: 0.8rem;
            flex-wrap: wrap;
            margin-top: auto;
        }
        .cost-item {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            border: 1px solid rgba(0,0,0,0.5);
        }

        /* í‹°ì–´ êµ¬ë¶„ */
        .tier-title {
            grid-column: 1 / -1;
            font-size: 0.8rem;
            color: #8b949e;
            margin-top: 5px;
            border-bottom: 1px solid #30363d;
        }

        /* ì•¡ì…˜ ë²„íŠ¼ */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* 3ê°œ ì¹¸ìœ¼ë¡œ ë³€ê²½ */
            gap: 10px;
        }
        button {
            padding: 15px;
            border: none;
            border-radius: 6px;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }
        .btn-scavenge {
            background: #238636;
            color: white;
        }
        .btn-scavenge:hover { background: #2ea043; }
        .btn-scavenge:disabled { background: #30363d; cursor: not-allowed; }

        /* ë¡œê·¸ */
        #game-log {
            height: 100px;
            overflow-y: auto;
            font-size: 0.8rem;
            background: #000;
            padding: 5px;
            border: 1px solid #30363d;
            font-family: monospace;
            color: #0f0;
        }

        /* ëª¨ë‹¬ (ìŠ¹ë¦¬ ë©”ì‹œì§€) */
        #modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background: #161b22;
            padding: 30px;
            border: 2px solid var(--accent-core);
            text-align: center;
            border-radius: 10px;
        }

    </style>
</head>
<body>

<div class="game-container">
    <header>
        <h1>NEON JUNK MARKET</h1>
        <div class="sub-text">HARD MODE: AI PRIORITY [WIN > GROWTH > DENIAL] + RECYCLE</div>
        <div id="turn-indicator" style="color: #58a6ff; margin-top:5px;">ë‹¹ì‹ ì˜ í„´</div>
    </header>

    <div class="area" style="border-color: #f85149;">
        <div class="area-header">
            <span>ğŸ¤– AI ê²½ìŸì (Scavenger Bot)</span>
            <span>VP: <span id="ai-vp">0</span> / 15</span>
        </div>
        <div class="resource-bar" id="ai-resources">
            </div>
        <div style="margin-top:5px; font-size:0.8rem; color:#8b949e;">
            ë³´ìœ  ì¹´ë“œ: <span id="ai-cards-count">0</span> | ì½”ì–´: <span id="ai-cores">0</span> | ë§ˆìŠ¤í„°í”¼ìŠ¤: <span id="ai-mp">X</span>
        </div>
    </div>

    <div class="area">
        <div class="area-header">ğŸ›’ ê³ ì²  ì²˜ë¦¬ì¥ (Market)</div>
        <div class="market-grid" id="market-area">
            </div>
    </div>

    <div class="area" style="border-color: #2ea043;">
        <div class="area-header">
            <span>ğŸ‘¤ ë‹¹ì‹  (Player)</span>
            <span>VP: <span id="player-vp">0</span> / 15</span>
        </div>
        <div class="resource-bar" id="player-resources">
            </div>
        <div style="margin-top:5px; font-size:0.8rem; color:#8b949e;">
            ë³´ìœ  ë³´ë„ˆìŠ¤(í• ì¸): <span id="player-bonuses">ì—†ìŒ</span>
        </div>
        <div style="margin-top:5px; font-size:0.8rem; color:var(--accent-core);">
             ë³´ìœ  ë§ˆìŠ¤í„°í”¼ìŠ¤: <span id="player-mp">X</span> (ìŠ¹ë¦¬ í•„ìˆ˜ ì¡°ê±´)
        </div>
        <div style="margin-top:5px; font-size:0.7rem; color:red;">
            âš ï¸ **ìì› í•œë„ 8ê°œ** (ìƒˆ ê·œì¹™)
        </div>
    </div>

    <div class="controls" style="grid-template-columns: 1fr 1fr 1fr;"> 
        <button class="btn-scavenge" id="btn-scavenge" onclick="playerScavenge()">
            ğŸ›  ë¶€í’ˆ ìˆ˜ì§‘<br><span style="font-size:0.7rem">(ëœë¤ ìì› 3ê°œ íšë“)</span>
        </button>
        <button class="btn-scavenge" id="btn-recycle" onclick="promptRecycle()" style="background:#58a6ff; color:black;">
            â™»ï¸ ìì› ì¬í™œìš©<br><span style="font-size:0.7rem">(ê°™ì€ ìì› 2ê°œ â†’ ë‹¤ë¥¸ ìì› 1ê°œ)</span>
        </button>
        <div style="display:flex; align-items:center; justify-content:center; font-size:0.8rem; color:#8b949e; text-align:center;">
            ì¹´ë“œë¥¼ í´ë¦­í•˜ì—¬ êµ¬ë§¤.<br>
            ìì› í•œë„ëŠ” 8ê°œì…ë‹ˆë‹¤.
        </div>
    </div>

    <div id="game-log">
        <div>ì‹œìŠ¤í…œ ê°€ë™... "ê·¹ì‹¬í•œ í¬ì†Œì„± í”„ë¡œí† ì½œ" ì‹œì‘.</div>
    </div>
</div>

<div id="modal">
    <div class="modal-content">
        <h2 id="modal-title">ê²Œì„ ì¢…ë£Œ</h2>
        <p id="modal-msg">ê²°ê³¼ ë‚´ìš©</p>
        <button onclick="location.reload()" style="background:var(--accent-core); color:black; margin-top:10px;">ë‹¤ì‹œ í•˜ê¸°</button>
    </div>
</div>

<script>
/**
 * ê²Œì„ ì„¤ì • ë° ë°ì´í„°
 */
const TYPES = ['screw', 'wire', 'alloy', 'battery']; // ê¸°ë³¸ ìì›
const SPECIAL = 'core'; // íŠ¹ìˆ˜ ìì›
const RESOURCE_CAP = 8; // **ìì› ìµœëŒ€ ë³´ìœ  í•œë„ 8ê°œ**

// ì¹´ë“œ ë°ì´í„° ìƒì„±ê¸° - ë¹„ìš© ìƒí–¥ ì¡°ì •
function generateDeck() {
    let deck = [];
    let idCounter = 0;

    // Tier 1: ì €ë¹„ìš©, ë¬´ì ìˆ˜, ê¸°ë³¸ ìì› ìƒì‚° (20ì¥)
    for(let i=0; i<20; i++) {
        const type = TYPES[Math.floor(Math.random() * 4)];
        deck.push({
            id: idCounter++, tier: 1, type: type, vp: 0,
            cost: { screw:1, wire:1, alloy:1, battery:1, core:0 }, // ë¹„ìš© ìƒí–¥
            isMp: false
        });
    }

    // Tier 2: ì¤‘ë¹„ìš©, ì†ŒëŸ‰ ì ìˆ˜ (15ì¥)
    for(let i=0; i<15; i++) {
        const type = TYPES[Math.floor(Math.random() * 4)];
        deck.push({
            id: idCounter++, tier: 2, type: type, vp: Math.floor(Math.random() * 2) + 1,
            cost: { screw: Math.floor(Math.random()*4), wire: Math.floor(Math.random()*4), alloy: Math.floor(Math.random()*4), battery: Math.floor(Math.random()*4), core: 0 },
            isMp: false
        });
    }

    // Tier 3: ê³ ë¹„ìš©, ì½”ì–´ ìƒì‚° (ë§¤ìš° ì¤‘ìš”) - 10ì¥
    const CORE_COSTS = [
        {screw: 5}, {wire: 5}, {alloy: 5}, {battery: 5},
        {screw: 3, wire: 3, alloy: 3}, {battery: 3, wire: 3, alloy: 3},
        {screw: 4, alloy: 4}
    ];
    for(let i=0; i<CORE_COSTS.length; i++) {
        let cost = { screw:0, wire:0, alloy:0, battery:0, core:0, ...CORE_COSTS[i] };
        deck.push({
            id: idCounter++, tier: 3, type: SPECIAL, vp: 3,
            cost: cost,
            isMp: false
        });
    }

    // Tier 4: ë§ˆìŠ¤í„°í”¼ìŠ¤ (ìŠ¹ë¦¬ ì¡°ê±´, ì½”ì–´ í•„ìš”) - 5ì¥
    // **ë¹„ìš© ëŒ€í­ ìƒí–¥** (ì½”ì–´ 5ê°œ ë° ê¸°ë³¸ ìì› ë‹¤ìˆ˜ ìš”êµ¬)
    for(let i=0; i<5; i++) {
        deck.push({
            id: idCounter++, tier: 4, type: 'mp', vp: 5,
            cost: { screw: 2, wire: 2, alloy: 2, battery: 2, core: 5 }, 
            isMp: true
        });
    }
    
    return deck.sort(() => Math.random() - 0.5);
}

/**
 * ê²Œì„ ìƒíƒœ ê´€ë¦¬ ë° ë Œë”ë§ í•¨ìˆ˜
 */

const state = {
    turn: 'player', 
    market: [],
    deck: generateDeck(),
    player: {
        resources: { screw:0, wire:0, alloy:0, battery:0, core:0 },
        bonus: { screw:0, wire:0, alloy:0, battery:0, core:0 },
        vp: 0,
        hasMp: false,
        hand: []
    },
    ai: {
        resources: { screw:0, wire:0, alloy:0, battery:0, core:0 },
        bonus: { screw:0, wire:0, alloy:0, battery:0, core:0 },
        vp: 0,
        hasMp: false,
        hand: []
    }
};

function initMarket() {
    let marketSlots = 8;
    let mpIndex = state.deck.findIndex(c => c.tier === 4);
    if(mpIndex > -1) {
        state.market.push(state.deck.splice(mpIndex, 1)[0]);
        marketSlots--;
    }
    
    for(let i=0; i<marketSlots; i++) {
        if(state.deck.length > 0) state.market.push(state.deck.shift());
    }
    state.market.sort((a,b) => a.tier - b.tier);
}

function render() {
    document.getElementById('player-vp').innerText = state.player.vp;
    document.getElementById('player-mp').innerText = state.player.hasMp ? "O (ì¡°ê±´ ì¶©ì¡±)" : "X";
    const pResDiv = document.getElementById('player-resources');
    pResDiv.innerHTML = renderResources(state.player.resources);
    
    let bonusText = "";
    TYPES.concat([SPECIAL]).forEach(t => {
        if(state.player.bonus[t] > 0) bonusText += `${typeToIcon(t)}${state.player.bonus[t]} `;
    });
    document.getElementById('player-bonuses').innerText = bonusText || "ì—†ìŒ";

    document.getElementById('ai-vp').innerText = state.ai.vp;
    document.getElementById('ai-cards-count').innerText = state.ai.hand.length;
    document.getElementById('ai-cores').innerText = state.ai.bonus.core + state.ai.resources.core;
    document.getElementById('ai-mp').innerText = state.ai.hasMp ? "O" : "X";
    const aiResDiv = document.getElementById('ai-resources');
    aiResDiv.innerHTML = renderResources(state.ai.resources);

    const marketDiv = document.getElementById('market-area');
    marketDiv.innerHTML = '';
    state.market.forEach(card => {
        const el = document.createElement('div');
        el.className = 'card';
        if (!canBuy(card, state.player)) el.classList.add('disabled');
        
        let typeColor = getResColor(card.type);
        if(card.isMp) el.style.borderColor = "#fff";

        el.innerHTML = `
            <div class="tier-title">Tier ${card.tier} ${card.isMp ? 'â˜…MASTERPIECE' : ''}</div>
            <div class="card-header">
                <span class="card-bonus" style="background:${typeColor}">${typeToIcon(card.type)}</span>
                <span class="card-vp">${card.vp > 0 ? card.vp : ''}</span>
            </div>
            <div class="cost-list">
                ${renderCost(card.cost)}
            </div>
        `;
        el.onclick = () => playerBuy(card);
        marketDiv.appendChild(el);
    });

    const turnInd = document.getElementById('turn-indicator');
    if(state.turn === 'player') {
        turnInd.innerText = "ë‹¹ì‹ ì˜ í„´ (í–‰ë™ì„ ì„ íƒí•˜ì„¸ìš”)";
        turnInd.style.color = "#2ed573";
        document.getElementById('btn-scavenge').disabled = false;
    } else {
        turnInd.innerText = "AI ìƒê° ì¤‘...";
        turnInd.style.color = "#f85149";
        document.getElementById('btn-scavenge').disabled = true;
    }
}

function renderResources(res) {
    let html = '';
    if(res.screw > 0) html += `<span class="res-badge res-screw">ğŸ”© ${res.screw}</span>`;
    if(res.wire > 0) html += `<span class="res-badge res-wire">ğŸ”Œ ${res.wire}</span>`;
    if(res.alloy > 0) html += `<span class="res-badge res-alloy">ğŸ›¡ï¸ ${res.alloy}</span>`;
    if(res.battery > 0) html += `<span class="res-badge res-battery">ğŸ”‹ ${res.battery}</span>`;
    if(res.core > 0) html += `<span class="res-badge res-core">âš¡ï¸ ${res.core}</span>`;
    return html;
}

function renderCost(cost) {
    let html = '';
    for(let [k, v] of Object.entries(cost)) {
        for(let i=0; i<v; i++) {
            let color = getResColor(k);
            html += `<span class="cost-item" style="background:${color}"></span>`;
        }
    }
    return html;
}

function getResColor(type) {
    if(type === 'screw') return 'var(--accent-screw)';
    if(type === 'wire') return 'var(--accent-wire)';
    if(type === 'alloy') return 'var(--accent-alloy)';
    if(type === 'battery') return 'var(--accent-battery)';
    if(type === 'core' || type === 'mp') return 'var(--accent-core)';
    return '#fff';
}

function typeToIcon(type) {
    const icons = { screw:'ğŸ”©', wire:'ğŸ”Œ', alloy:'ğŸ›¡ï¸', battery:'ğŸ”‹', core:'âš¡ï¸', mp:'ğŸ‘‘' };
    return icons[type] || '';
}

function log(msg) {
    const logDiv = document.getElementById('game-log');
    const line = document.createElement('div');
    line.innerText = `> ${msg}`;
    logDiv.appendChild(line);
    logDiv.scrollTop = logDiv.scrollHeight;
}

/**
 * ê²Œì„ ë¡œì§
 */

function canBuy(card, actor) {
    for(let resType in card.cost) {
        let cost = card.cost[resType];
        if(cost > 0) {
            let discounted = Math.max(0, cost - (actor.bonus[resType] || 0));
            if(actor.resources[resType] < discounted) return false;
        }
    }
    return true;
}

function payCost(card, actor) {
    for(let resType in card.cost) {
        let cost = card.cost[resType];
        if(cost > 0) {
            let discounted = Math.max(0, cost - (actor.bonus[resType] || 0));
            actor.resources[resType] -= discounted;
        }
    }
}

function checkWin(actorName) {
    const actor = actorName === 'player' ? state.player : state.ai;
    if (actor.vp >= 15 && actor.hasMp) {
        let msg = actorName === 'player' ? "ì¶•í•˜í•©ë‹ˆë‹¤! íê¸°ì¥ì˜ ì œì™•ì´ ë˜ì…¨ìŠµë‹ˆë‹¤." : "íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤. AIê°€ ì‹œì¥ì„ ì¥ì•…í–ˆìŠµë‹ˆë‹¤.";
        document.getElementById('modal-title').innerText = actorName === 'player' ? "VICTORY" : "DEFEAT";
        document.getElementById('modal-msg').innerText = msg;
        document.getElementById('modal').style.display = 'flex';
        return true;
    }
    return false;
}

// **í”Œë ˆì´ì–´ í–‰ë™: ìì› ìˆ˜ì§‘**
function playerScavenge() {
    if(state.turn !== 'player') return;
    
    let total = Object.values(state.player.resources).reduce((a,b)=>a+b, 0);
    if(total >= RESOURCE_CAP) {
        log(`[ê²½ê³ ] ì°½ê³  í•œë„(${RESOURCE_CAP}ê°œ) ì´ˆê³¼! ì¹´ë“œë¥¼ êµ¬ë§¤í•˜ê±°ë‚˜ ì¬í™œìš©í•˜ì„¸ìš”.`);
        return;
    }

    let gained = [];
    let pool = [...TYPES];
    
    for(let i=0; i<3; i++) {
        if(pool.length === 0) break;
        let randomIndex = Math.floor(Math.random() * pool.length);
        let resource = pool[randomIndex];
        
        state.player.resources[resource]++;
        gained.push(resource);

        let count = gained.filter(r => r === resource).length;
        if(count >= 2) {
             pool = pool.filter(r => r !== resource);
        }
    }

    let gainText = gained.map(typeToIcon).join(' ');
    log(`ë¶€í’ˆ ìˆ˜ì§‘ ì™„ë£Œ: ${gainText}`);
    endTurn();
}

// **í”Œë ˆì´ì–´ í–‰ë™: ì¬í™œìš© (Deadlock í•´ì œ ì•¡ì…˜)**
function promptRecycle() {
    if(state.turn !== 'player') return;

    let availableText = TYPES.map(t => `${typeToIcon(t)}: ${state.player.resources[t]}`).join(' | ');
    log(`[ì¬í™œìš©] í˜„ì¬ ìì›: ${availableText}`);
    
    let input = prompt(`[ì¬í™œìš© ì•¡ì…˜]
    ê°™ì€ ìì› 2ê°œë¥¼ ì†Œëª¨í•˜ì—¬ ë‹¤ë¥¸ ìì› 1ê°œë¥¼ ì–»ìŠµë‹ˆë‹¤.
    
    1. ì†Œëª¨í•  ìì› ì…ë ¥ (ì˜ˆ: screw)
    2. ì–»ì„ ìì› ì…ë ¥ (ì˜ˆ: wire)
    
    ì…ë ¥ í˜•ì‹: [ì†Œëª¨ìì›]/[íšë“ìì›] (ì˜ˆ: screw/wire)
    `);

    if (!input) {
        log("ì¬í™œìš© ì·¨ì†Œ.");
        return;
    }

    const parts = input.toLowerCase().split('/');
    if (parts.length !== 2) {
        log("ì˜ëª»ëœ ì…ë ¥ í˜•ì‹ì…ë‹ˆë‹¤. 'ì†Œëª¨ìì›/íšë“ìì›' í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
        
    }

    const [discardType, gainType] = parts;

    if (!TYPES.includes(discardType) || !TYPES.includes(gainType) || discardType === gainType) {
        log("ìœ íš¨í•˜ì§€ ì•Šì€ ìì›ì…ë‹ˆë‹¤. (screw, wire, alloy, battery ì¤‘ ì„ íƒ)");
        return;
    }

    if (state.player.resources[discardType] < 2) {
        log(`${typeToIcon(discardType)} ${discardType} ìì›ì´ 2ê°œ ë¯¸ë§Œì…ë‹ˆë‹¤.`);
        return;
    }
    
    // êµí™˜ ì‹¤í–‰
    state.player.resources[discardType] -= 2;
    state.player.resources[gainType] += 1;
    log(`ì¬í™œìš© ì„±ê³µ: ${typeToIcon(discardType)} 2ê°œ ì†Œëª¨ -> ${typeToIcon(gainType)} 1ê°œ íšë“`);
    
    // ìì› í•œë„ ì²´í¬ (ì¬í™œìš©ì€ í•œë„ê°€ ìë™ìœ¼ë¡œ ë‚®ì•„ì§€ë¯€ë¡œ ì‚¬ì‹¤ìƒ ë¶ˆí•„ìš”)
    let total = Object.values(state.player.resources).filter((_, i) => i < 4).reduce((a,b)=>a+b,0);
    if(total > RESOURCE_CAP) {
        log("[ê²½ê³ ] ì¬í™œìš© í›„ ìì› í•œë„ ì´ˆê³¼! ì‹œìŠ¤í…œ ì˜¤ë¥˜ ê°ì§€.");
        let maxRes = TYPES.reduce((a, b) => state.player.resources[a] > state.player.resources[b] ? a : b);
        state.player.resources[maxRes]--;
    }
    
    endTurn();
}


function playerBuy(card) {
    if(state.turn !== 'player') return;
    if(!canBuy(card, state.player)) {
        log("ìì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
        return;
    }

    payCost(card, state.player);
    
    if(card.isMp) {
        state.player.hasMp = true;
        log("!!! ë§ˆìŠ¤í„°í”¼ìŠ¤ íšë“ !!!");
    } else {
        state.player.bonus[card.type]++;
    }
    state.player.vp += card.vp;
    state.player.hand.push(card);
    
    state.market = state.market.filter(c => c.id !== card.id);
    if(state.deck.length > 0) state.market.push(state.deck.shift());
    state.market.sort((a,b) => a.tier - b.tier);

    log(`ì¹´ë“œ êµ¬ë§¤ ì™„ë£Œ: Tier ${card.tier} (VP+${card.vp})`);
    
    if(!checkWin('player')) endTurn();
}

function endTurn() {
    state.turn = 'ai';
    render();
    setTimeout(aiTurn, 1000);
}

// AI ë³´ì¡° í•¨ìˆ˜: í”Œë ˆì´ì–´ê°€ ì¹´ë“œë¥¼ êµ¬ë§¤í•˜ê¸° ìœ„í•´ ì–¼ë§ˆë‚˜ ë§ì€ ìì›ì´ ë¶€ì¡±í•œì§€ ê³„ì‚°
function getMissingResources(card, actor) {
    let missing = {};
    let totalMissing = 0;
    for(let resType in card.cost) {
        let cost = card.cost[resType];
        if(cost > 0) {
            let discounted = Math.max(0, cost - (actor.bonus[resType] || 0));
            let needed = discounted - actor.resources[resType];
            if(needed > 0) {
                missing[resType] = needed;
                totalMissing += needed;
            }
        }
    }
    return { missing, totalMissing };
}

function endTurnAI() {
    // ìì› í•œë„ ì´ˆê³¼ ì‹œ ë²„ë¦¬ê¸° (ê°€ì¥ ë§ì€ ìì› ë²„ë¦¼)
    let totalRes = Object.values(state.ai.resources).filter((_, i) => i < 4).reduce((a,b)=>a+b,0);
    while(totalRes > RESOURCE_CAP) {
        let maxRes = TYPES.reduce((a, b) => state.ai.resources[a] > state.ai.resources[b] ? a : b);
        state.ai.resources[maxRes]--;
        totalRes--;
    }

    state.turn = 'player';
    render();
}

function aiBuy(card) {
    payCost(card, state.ai);
    if(card.isMp) {
        state.ai.hasMp = true;
        log("AI: [ê²½ê³ ] ë§ˆìŠ¤í„°í”¼ìŠ¤ êµ¬ë§¤ ì™„ë£Œ.");
    } else {
        state.ai.bonus[card.type]++;
    }
    state.ai.vp += card.vp;
    state.ai.hand.push(card);

    state.market = state.market.filter(c => c.id !== card.id);
    if(state.deck.length > 0) state.market.push(state.deck.shift());
    state.market.sort((a,b) => a.tier - b.tier);

    log(`AI: ì¹´ë“œ êµ¬ë§¤ (VP+${card.vp})`);
    
    if(!checkWin('ai')) {
        state.turn = 'player';
        render();
    }
}


/**
 * ğŸ¤– AI ë¡œì§ (The Scavenger Bot) - ìŠ¹ë¦¬ ì§€í–¥ ìš°ì„ ìˆœìœ„ ì ìš© (ì¬í™œìš© ë¡œì§ í¬í•¨)
 */
function aiTurn() {
    const ai = state.ai;
    const player = state.player;
    
    // 1. ğŸ¥‡ 1ìˆœìœ„: ìŠ¹ë¦¬ ê°€ëŠ¥í•œì§€ ì²´í¬ (ë§ˆìŠ¤í„°í”¼ìŠ¤ êµ¬ë§¤ ê°€ëŠ¥?)
    const winConditionCard = state.market.find(c => c.isMp && canBuy(c, ai));
    if (winConditionCard) {
        log("AI: [1ìˆœìœ„] ë§ˆìŠ¤í„°í”¼ìŠ¤ êµ¬ë§¤ë¡œ ìŠ¹ë¦¬ ì‹œë„.");
        aiBuy(winConditionCard); 
        return;
    }

    // 2. ğŸ¥ˆ 2ìˆœìœ„: êµ¬ë§¤ ê°€ëŠ¥í•œ ì¹´ë“œ ì¤‘ ìµœì ì˜ ì¹´ë“œ ì°¾ê¸° (ìê¸° ì„±ì¥)
    let bestCard = null;
    let bestScore = -1;

    state.market.forEach(card => {
        if(canBuy(card, ai)) {
            let score = card.vp * 2;
            if(card.type === 'core') score += 10; 
            if(card.tier === 1) score += 1; 
            
            if(score > bestScore) {
                bestScore = score;
                bestCard = card;
            }
        }
    });

    if (bestCard) {
        log(`AI: [2ìˆœìœ„] Tier ${bestCard.tier} ì¹´ë“œ êµ¬ë§¤ë¡œ ì„±ì¥.`);
        aiBuy(bestCard);
        return;
    }
    
    // 3. ğŸ¥‰ 3ìˆœìœ„: ì¬í™œìš©, ê²¬ì œ ë˜ëŠ” ìì› ìˆ˜ì§‘

    // A. AI ì¬í™œìš© ì²´í¬ (ìê¸° ì„±ì¥ì´ ë§‰í˜”ì„ ë•Œ, ìì› êµ¬ì„±ì„ ë°”ê¿” êµ¬ë§¤ë¥¼ ì‹œë„)
    const targetCoreCard = state.market.find(c => c.type === 'core' && !canBuy(c, ai));

    if (targetCoreCard) {
        const { missing: aiMissing } = getMissingResources(targetCoreCard, ai);
        const neededType = Object.keys(aiMissing).find(t => aiMissing[t] === 1); // 1ê°œë§Œ ë¶€ì¡±í•œ ê²½ìš°
        const excessType = TYPES.find(t => ai.resources[t] >= 2 && t !== neededType); // 2ê°œ ì´ìƒ ê°€ì§„ ìì›

        if (neededType && excessType) {
            
            // ì¬í™œìš© í›„ êµ¬ë§¤ ê°€ëŠ¥í•œì§€ (ì‹œë®¬ë ˆì´ì…˜ ì²´í¬)
            let tempAI = JSON.parse(JSON.stringify(ai));
            tempAI.resources[excessType] -= 2;
            tempAI.resources[neededType] += 1;
            
            if (canBuy(targetCoreCard, tempAI)) {
                ai.resources[excessType] -= 2;
                ai.resources[neededType] += 1;
                log(`AI: [3ìˆœìœ„/ì¬í™œìš©] ${typeToIcon(excessType)} 2ê°œ ì†Œëª¨í•˜ì—¬ ${typeToIcon(neededType)} 1ê°œ íšë“, êµ¬ë§¤ ì‹œë„.`);
                
                // ì¬í™œìš© í›„ ë°”ë¡œ êµ¬ë§¤ ì‹œë„ (í„´ ì†Œëª¨ ìµœì†Œí™”)
                if(canBuy(targetCoreCard, ai)) {
                    aiBuy(targetCoreCard);
                } else {
                    endTurnAI();
                }
                return;
            }
        }
    }


    // B. í”Œë ˆì´ì–´ ê²¬ì œ ì²´í¬ (í•µì‹¬ ì¹´ë“œ êµ¬ë§¤ ì§ì „ì´ë¼ë©´)
    let playerNearBuy = null;
    let minMissingTurns = 99;
    
    state.market.forEach(card => {
        const { totalMissing } = getMissingResources(card, player);
        if (totalMissing > 0 && totalMissing <= 2 && card.tier >= 3) {
            if (totalMissing < minMissingTurns) {
                minMissingTurns = totalMissing;
                playerNearBuy = card;
            }
        }
    });
    
    if (playerNearBuy) {
        const { missing } = getMissingResources(playerNearBuy, player);
        const targetRes = Object.keys(missing).find(r => missing[r] > 0);
        
        if (targetRes && ai.resources[targetRes] < RESOURCE_CAP) {
            ai.resources[targetRes]++;
            log(`AI: [3ìˆœìœ„/ê²¬ì œ] í”Œë ˆì´ì–´ì˜ ìì› ${typeToIcon(targetRes)}ì„(ë¥¼) ì„ ì .`);
            endTurnAI();
            return;
        }
    }

    // C. AI ì„±ì¥ ëª©í‘œë¥¼ ìœ„í•œ ìì› ìˆ˜ì§‘ (í‰ìƒì‹œ í–‰ë™)
    let needed = [];
    const targetCard = state.market.find(c => c.type === 'core' && !canBuy(c, ai)) || 
                       state.market.find(c => c.vp > 0 && !canBuy(c, ai)) ||
                       state.market[0];

    if(targetCard) {
        const { missing } = getMissingResources(targetCard, ai);
        const sortedMissing = Object.entries(missing).sort(([,a],[,b]) => b-a);
        needed = sortedMissing.slice(0, 3).map(([key]) => key);
    }

    let collectedCount = 0;
    while(collectedCount < 3) {
        let pick = needed.length > 0 ? needed.shift() : TYPES[Math.floor(Math.random() * 4)];
        
        if (ai.resources[pick] < RESOURCE_CAP) {
            ai.resources[pick]++;
            collectedCount++;
        } else {
            break;
        }
    }
    
    log("AI: [3ìˆœìœ„/ì„±ì¥] ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•œ ìì› ìˆ˜ì§‘.");
    endTurnAI();
}


// ì´ˆê¸°í™” ì‹¤í–‰
initMarket();
render();

</script>
</body>
</html>
